<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>315212551e86465a8a972e1ecbb436b8</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="sparkify-project-workspace" class="cell markdown"
id="2ui2WU4kLfOB">
<h1>Sparkify Project Workspace</h1>
<p>This workspace contains a tiny subset (128MB) of the full dataset
available (12GB). Feel free to use this workspace to build your project,
or to explore a smaller subset with Spark before deploying your cluster
on the cloud. Instructions for setting up your Spark cluster is included
in the last lesson of the Extracurricular Spark Course content.</p>
<p>You can follow the steps below to guide your data analysis and model
building portion of this project.</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="50ek_62ILppJ" data-outputId="240e3579-c6ef-4053-fa42-5b02679a39cf">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install pyspark</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Requirement already satisfied: pyspark in /usr/local/lib/python3.10/dist-packages (3.4.1)
Requirement already satisfied: py4j==0.10.9.7 in /usr/local/lib/python3.10/dist-packages (from pyspark) (0.10.9.7)
</code></pre>
</div>
</div>
<div class="cell code" id="itYlif7eLfOE">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import libraries</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark <span class="im">import</span> SparkConf</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> udf</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> StringType</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> IntegerType</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> isnan, count, when, col, desc, udf, col, sort_array, asc, avg</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> <span class="bu">sum</span> <span class="im">as</span> Fsum</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.window <span class="im">import</span> Window</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> Row</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.classification <span class="im">import</span> LogisticRegression, RandomForestClassifier, GBTClassifier, LinearSVC, NaiveBayes</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> MulticlassClassificationEvaluator</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> CountVectorizer, IDF, PCA, RegexTokenizer, VectorAssembler, Normalizer, StandardScaler</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.tuning <span class="im">import</span> CrossValidator, ParamGridBuilder</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span></code></pre></div>
</div>
<div class="cell code" id="hpmCqsS3LfOG">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a Spark session</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession <span class="op">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    .builder <span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    .appName(<span class="st">&quot;Udacity Capstone Project&quot;</span>) <span class="op">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    .getOrCreate()</span></code></pre></div>
</div>
<section id="load-and-clean-dataset" class="cell markdown"
id="xotL4bMULfOG">
<h1>Load and Clean Dataset</h1>
<p>In this workspace, the mini-dataset file is
<code>mini_sparkify_event_data.json</code>. Load and clean the dataset,
checking for invalid or missing data - for example, records without
userids or sessionids.</p>
</section>
<section id="loading-dataset" class="cell markdown" id="4zbmV8ekLfOH">
<h3>Loading dataset</h3>
</section>
<div class="cell code" id="txU7CSAPLfOH">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load dataset</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.json(<span class="st">&quot;mini_sparkify_event_data.json&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="gCaTd4hHLfOH" data-outputId="d96364f3-8a02-4dc5-c689-16536f1fa413">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Schema of dataset</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df.printSchema()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>root
 |-- artist: string (nullable = true)
 |-- auth: string (nullable = true)
 |-- firstName: string (nullable = true)
 |-- gender: string (nullable = true)
 |-- itemInSession: long (nullable = true)
 |-- lastName: string (nullable = true)
 |-- length: double (nullable = true)
 |-- level: string (nullable = true)
 |-- location: string (nullable = true)
 |-- method: string (nullable = true)
 |-- page: string (nullable = true)
 |-- registration: long (nullable = true)
 |-- sessionId: long (nullable = true)
 |-- song: string (nullable = true)
 |-- status: long (nullable = true)
 |-- ts: long (nullable = true)
 |-- userAgent: string (nullable = true)
 |-- userId: string (nullable = true)

</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="ELjXHbEALfOI" data-outputId="07988bb6-70b4-4037-b661-dfade4544081">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show first 5 rows</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">5</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="10">
<pre><code>[Row(artist=&#39;Martha Tilston&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=50, lastName=&#39;Freeman&#39;, length=277.89016, level=&#39;paid&#39;, location=&#39;Bakersfield, CA&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538173362000, sessionId=29, song=&#39;Rockpools&#39;, status=200, ts=1538352117000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0&#39;, userId=&#39;30&#39;),
 Row(artist=&#39;Five Iron Frenzy&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Micah&#39;, gender=&#39;M&#39;, itemInSession=79, lastName=&#39;Long&#39;, length=236.09424, level=&#39;free&#39;, location=&#39;Boston-Cambridge-Newton, MA-NH&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538331630000, sessionId=8, song=&#39;Canada&#39;, status=200, ts=1538352180000, userAgent=&#39;&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36&quot;&#39;, userId=&#39;9&#39;),
 Row(artist=&#39;Adam Lambert&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=51, lastName=&#39;Freeman&#39;, length=282.8273, level=&#39;paid&#39;, location=&#39;Bakersfield, CA&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538173362000, sessionId=29, song=&#39;Time For Miracles&#39;, status=200, ts=1538352394000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0&#39;, userId=&#39;30&#39;),
 Row(artist=&#39;Enigma&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Micah&#39;, gender=&#39;M&#39;, itemInSession=80, lastName=&#39;Long&#39;, length=262.71302, level=&#39;free&#39;, location=&#39;Boston-Cambridge-Newton, MA-NH&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538331630000, sessionId=8, song=&#39;Knocking On Forbidden Doors&#39;, status=200, ts=1538352416000, userAgent=&#39;&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36&quot;&#39;, userId=&#39;9&#39;),
 Row(artist=&#39;Daft Punk&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=52, lastName=&#39;Freeman&#39;, length=223.60771, level=&#39;paid&#39;, location=&#39;Bakersfield, CA&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538173362000, sessionId=29, song=&#39;Harder Better Faster Stronger&#39;, status=200, ts=1538352676000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0&#39;, userId=&#39;30&#39;)]</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="u7RUSki6LfOI" data-outputId="863fe5a2-0e64-441e-91b0-66d594c38368">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#size of dataframe</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="11">
<pre><code>84595</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="SHOP2Lj-LfOJ" data-outputId="f5ba97a6-5907-4be0-8055-280731d33642">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df.columns)</span></code></pre></div>
<div class="output execute_result" data-execution_count="12">
<pre><code>18</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="jJIVhzZgLfOJ" data-outputId="3ca80479-b37f-4b95-8bb4-7a78adfecaff">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df.describe()</span></code></pre></div>
<div class="output execute_result" data-execution_count="13">
<pre><code>DataFrame[summary: string, artist: string, auth: string, firstName: string, gender: string, itemInSession: string, lastName: string, length: string, level: string, location: string, method: string, page: string, registration: string, sessionId: string, song: string, status: string, ts: string, userAgent: string, userId: string]</code></pre>
</div>
</div>
<div class="cell markdown" id="krkwqxuiLfOJ">
<p><strong>Sumary of the dataset</strong></p>
<ul>
<li>There are total 286500 rows and 18 columns before clean</li>
<li><code>df.printSchema()</code> show all columns name and its data
type =&gt; data type of all columns are looking good so we don't have to
make changes in this dataframe</li>
<li>In order to understand the data, here is one example in
<code>df.head(5)</code>: <strong>(artist='Martha Tilston', auth='Logged
In', firstName='Colin', gender='M', itemInSession=50,
lastName='Freeman', length=277.89016, level='paid',
location='Bakersfield, CA', method='PUT', page='NextSong',
registration=1538173362000, sessionId=29, song='Rockpools', status=200,
ts=1538352117000, userAgent='Mozilla/5.0 (Windows NT 6.1; WOW64;
rv:31.0) Gecko/20100101 Firefox/31.0', userId='30')</strong></li>
</ul>
</div>
<section id="cleaning" class="cell markdown" id="dbP7vxC0LfOJ">
<h3>Cleaning</h3>
</section>
<section id="1-remove-rows-with-missing-values" class="cell markdown"
id="qaQNO2yELfOJ">
<h4>1/ Remove Rows with Missing Values</h4>
<p>Initially, we will eliminate any rows that contain missing values in
the 'userid' or 'sessionid' columns.</p>
</section>
<div class="cell code" id="QltwvEnsLfOL">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing values in &#39;userId&#39; or &#39;sessionId&#39;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.dropna(how<span class="op">=</span><span class="st">&#39;any&#39;</span>, subset<span class="op">=</span>[<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;sessionId&#39;</span>])</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="19S6cainLfOM" data-outputId="bfb1778c-8ec1-47b3-c4e9-cdbdde4dd07c">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="15">
<pre><code>84595</code></pre>
</div>
</div>
<div class="cell markdown" id="Or3RrlX6LfOM">
<p>As we can see from the above, the row count is still the same at
286500. Let's deep dive into these 2 columns</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="8g627QMxLfOM" data-outputId="03474dd0-7c90-47df-8c99-aebe5d51dd4a">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop userid duplicates</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">&quot;userId&quot;</span>).dropDuplicates().distinct().sort(<span class="st">&quot;userId&quot;</span>).show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+
|userId|
+------+
|      |
|    10|
|   100|
|   101|
|   102|
|   103|
|   104|
|   105|
|   106|
|   107|
|   108|
|   109|
|    11|
|   110|
|   111|
|   112|
|   113|
|   114|
|   115|
|   117|
+------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="iKEiEDw-LfON">
<p>We can see that there are empty string in column "userId". Let's see
if we have the same problem in column "sessionId"</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="dTvvuPVALfON" data-outputId="a4682d54-34eb-4a56-bd2f-9a470fb216fa">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop sessionId duplicates</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">&quot;sessionId&quot;</span>).dropDuplicates().distinct().sort(<span class="st">&quot;sessionId&quot;</span>).show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+---------+
|sessionId|
+---------+
|        1|
|        5|
|        8|
|        9|
|       10|
|       11|
|       23|
|       26|
|       27|
|       28|
|       29|
|       33|
|       35|
|       36|
|       39|
|       42|
|       44|
|       46|
|       52|
|       53|
+---------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="AxCxWMqtLfON">
<p>We don't have that problem in column sessionId. Let's apply some
transformation to fix issue in column "userId"</p>
</div>
<div class="cell code" id="KDuwOaTYLfON">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter out all rows that have userId is empty string</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.<span class="bu">filter</span>(df[<span class="st">&quot;userId&quot;</span>] <span class="op">!=</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="M6UnvNTnLfOO" data-outputId="4381f400-68a1-48a0-fbda-1a0e48ee083e">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="19">
<pre><code>82076</code></pre>
</div>
</div>
<div class="cell markdown" id="wjQQqUpDLfOO">
<p>The new dataframe will have 278154 rows after cleaning steps</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1000}"
id="u7NELdruLfOO" data-outputId="7c8d001a-f0c0-4b7a-8aee-a69be59d0e7a">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_pandas <span class="op">=</span> df.toPandas()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>df_pandas</span></code></pre></div>
<div class="output execute_result" data-execution_count="20">

  <div id="df-d3ef7805-2803-4882-9ed8-bea907a03fb6" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>artist</th>
      <th>auth</th>
      <th>firstName</th>
      <th>gender</th>
      <th>itemInSession</th>
      <th>lastName</th>
      <th>length</th>
      <th>level</th>
      <th>location</th>
      <th>method</th>
      <th>page</th>
      <th>registration</th>
      <th>sessionId</th>
      <th>song</th>
      <th>status</th>
      <th>ts</th>
      <th>userAgent</th>
      <th>userId</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Martha Tilston</td>
      <td>Logged In</td>
      <td>Colin</td>
      <td>M</td>
      <td>50</td>
      <td>Freeman</td>
      <td>277.89016</td>
      <td>paid</td>
      <td>Bakersfield, CA</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538173362000</td>
      <td>29</td>
      <td>Rockpools</td>
      <td>200</td>
      <td>1538352117000</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) G...</td>
      <td>30</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Five Iron Frenzy</td>
      <td>Logged In</td>
      <td>Micah</td>
      <td>M</td>
      <td>79</td>
      <td>Long</td>
      <td>236.09424</td>
      <td>free</td>
      <td>Boston-Cambridge-Newton, MA-NH</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538331630000</td>
      <td>8</td>
      <td>Canada</td>
      <td>200</td>
      <td>1538352180000</td>
      <td>"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebK...</td>
      <td>9</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Adam Lambert</td>
      <td>Logged In</td>
      <td>Colin</td>
      <td>M</td>
      <td>51</td>
      <td>Freeman</td>
      <td>282.82730</td>
      <td>paid</td>
      <td>Bakersfield, CA</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538173362000</td>
      <td>29</td>
      <td>Time For Miracles</td>
      <td>200</td>
      <td>1538352394000</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) G...</td>
      <td>30</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Enigma</td>
      <td>Logged In</td>
      <td>Micah</td>
      <td>M</td>
      <td>80</td>
      <td>Long</td>
      <td>262.71302</td>
      <td>free</td>
      <td>Boston-Cambridge-Newton, MA-NH</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538331630000</td>
      <td>8</td>
      <td>Knocking On Forbidden Doors</td>
      <td>200</td>
      <td>1538352416000</td>
      <td>"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebK...</td>
      <td>9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Daft Punk</td>
      <td>Logged In</td>
      <td>Colin</td>
      <td>M</td>
      <td>52</td>
      <td>Freeman</td>
      <td>223.60771</td>
      <td>paid</td>
      <td>Bakersfield, CA</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538173362000</td>
      <td>29</td>
      <td>Harder Better Faster Stronger</td>
      <td>200</td>
      <td>1538352676000</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) G...</td>
      <td>30</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>82071</th>
      <td>None</td>
      <td>Logged In</td>
      <td>Lina</td>
      <td>F</td>
      <td>2</td>
      <td>Francis</td>
      <td>NaN</td>
      <td>paid</td>
      <td>Los Angeles-Long Beach-Anaheim, CA</td>
      <td>PUT</td>
      <td>Logout</td>
      <td>1536948181000</td>
      <td>1206</td>
      <td>None</td>
      <td>307</td>
      <td>1540458742000</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) G...</td>
      <td>115</td>
    </tr>
    <tr>
      <th>82072</th>
      <td>The Temper Trap</td>
      <td>Logged In</td>
      <td>Samuel</td>
      <td>M</td>
      <td>286</td>
      <td>Wood</td>
      <td>358.68689</td>
      <td>paid</td>
      <td>New York-Newark-Jersey City, NY-NJ-PA</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1537865819000</td>
      <td>1158</td>
      <td>Soldier On</td>
      <td>200</td>
      <td>1540458749000</td>
      <td>"Mozilla/5.0 (iPad; CPU OS 7_1_1 like Mac OS X...</td>
      <td>138</td>
    </tr>
    <tr>
      <th>82073</th>
      <td>Shy Child</td>
      <td>Logged In</td>
      <td>Sawyer</td>
      <td>M</td>
      <td>11</td>
      <td>Larson</td>
      <td>203.33669</td>
      <td>paid</td>
      <td>Houston-The Woodlands-Sugar Land, TX</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1538069638000</td>
      <td>1139</td>
      <td>Kick Drum</td>
      <td>200</td>
      <td>1540458773000</td>
      <td>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4...</td>
      <td>98</td>
    </tr>
    <tr>
      <th>82074</th>
      <td>Cradle Of Filth</td>
      <td>Logged In</td>
      <td>Payton</td>
      <td>F</td>
      <td>68</td>
      <td>Campbell</td>
      <td>371.66975</td>
      <td>paid</td>
      <td>Los Angeles-Long Beach-Anaheim, CA</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1529027541000</td>
      <td>1235</td>
      <td>Better To Reign In Hell</td>
      <td>200</td>
      <td>1540458794000</td>
      <td>"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebK...</td>
      <td>39</td>
    </tr>
    <tr>
      <th>82075</th>
      <td>Enrique Iglesias</td>
      <td>Logged In</td>
      <td>Casey</td>
      <td>F</td>
      <td>19</td>
      <td>Ramirez</td>
      <td>213.02812</td>
      <td>paid</td>
      <td>St. Louis, MO-IL</td>
      <td>PUT</td>
      <td>NextSong</td>
      <td>1534768517000</td>
      <td>1155</td>
      <td>Bailamos</td>
      <td>200</td>
      <td>1540458806000</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) G...</td>
      <td>109</td>
    </tr>
  </tbody>
</table>
<p>82076 rows × 18 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-d3ef7805-2803-4882-9ed8-bea907a03fb6')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-d3ef7805-2803-4882-9ed8-bea907a03fb6 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-d3ef7805-2803-4882-9ed8-bea907a03fb6');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-afea770f-8ffa-4041-951c-94d7b6fe2bb7">
  <button class="colab-df-quickchart" onclick="quickchart('df-afea770f-8ffa-4041-951c-94d7b6fe2bb7')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-afea770f-8ffa-4041-951c-94d7b6fe2bb7 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code" id="-s0dxKMtLfOP">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<section id="exploratory-data-analysis" class="cell markdown"
id="02MkAF--LfOP">
<h1>Exploratory Data Analysis</h1>
<p>When you're working with the full dataset, perform EDA by loading a
small subset of the data and doing basic manipulations within Spark. In
this workspace, you are already provided a small subset of data you can
explore.</p>
<h3 id="define-churn">Define Churn</h3>
<p>Once you've done some preliminary analysis, create a column
<code>Churn</code> to use as the label for your model. I suggest using
the <code>Cancellation Confirmation</code> events to define your churn,
which happen for both paid and free users. As a bonus task, you can also
look into the <code>Downgrade</code> events.</p>
<h3 id="explore-data">Explore Data</h3>
<p>Once you've defined churn, perform some exploratory data analysis to
observe the behavior for users who stayed vs users who churned. You can
start by exploring aggregates on these two groups of users, observing
how much of a specific action they experienced per a certain time unit
or number of songs played.</p>
</section>
<section id="identify-users-who-have-churned" class="cell markdown"
id="XpUJuVndLfOP">
<h3>Identify users who have churned</h3>
<p>Initially, we will identify users who have churned by filtering for
the <strong>Cancellation Confirmation</strong> event under the
<strong>page</strong> column.</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="UKLR8pj8LfOP" data-outputId="c802ce59-5e6b-4a1a-c29e-ea3751520e87">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check Cancellation Confirmation page</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">&quot;page&quot;</span>).dropDuplicates().show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+--------------------+
|                page|
+--------------------+
|              Cancel|
|    Submit Downgrade|
|         Thumbs Down|
|                Home|
|           Downgrade|
|         Roll Advert|
|              Logout|
|       Save Settings|
|Cancellation Conf...|
|               About|
|            Settings|
|     Add to Playlist|
|          Add Friend|
|            NextSong|
|           Thumbs Up|
|                Help|
|             Upgrade|
|               Error|
|      Submit Upgrade|
+--------------------+

</code></pre>
</div>
</div>
<div class="cell markdown" id="j0WgmLo7LfOQ">
<p>As mentioned earlier, the <strong>Cancellation Confirmation</strong>
page is where a user is directed after confirming their decision to
cancel their service. This event serves as our indicator for identifying
churn.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="YSMd5KM-LfOQ" data-outputId="41e12936-b1b6-4d0b-f9d2-79c9a50a8ad2">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of users who churned</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>]).where(df.page <span class="op">==</span> <span class="st">&quot;Cancellation Confirmation&quot;</span>).count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="22">
<pre><code>15</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="3E-1z_mSLfOQ" data-outputId="f19ba8ba-852d-42d7-82d9-e684eb086335">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of users who churned</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>churned_users_count <span class="op">=</span> df.<span class="bu">filter</span>((df.page <span class="op">==</span> <span class="st">&quot;Cancellation Confirmation&quot;</span>)).select(<span class="st">&quot;userId&quot;</span>).distinct()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>churned_users_count.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="23">
<pre><code>15</code></pre>
</div>
</div>
<div class="cell markdown" id="7lQFKBSwLfOQ">
<p>As observed in the previous cell, our dataset contains 52 users who
have churned. To examine these users in more detail, we can inspect
their user IDs.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="98CsY40dLfOR" data-outputId="49026b23-c2a8-4da5-e2aa-e54e6122095d">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>churned_users_count.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+
|userId|
+------+
|   125|
|    18|
|    17|
|   143|
|    32|
|   105|
|    51|
|   101|
|    87|
|    73|
|   122|
|    58|
|   121|
|    12|
|   129|
+------+

</code></pre>
</div>
</div>
<div class="cell markdown" id="-dWopANyLfOR">
<p>Now, we will create a churn flag for users. Users who have churned
will be assigned a value of 1, and those who have not churned will
receive a 0. This flag will be added as a new column in the dataset,
named "churn".</p>
</div>
<div class="cell code" id="RH_9FYuTLfOR">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to flag churn events</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>churn_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Cancellation Confirmation&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the &#39;churn&#39; column to the dataset</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">&quot;churn&quot;</span>, churn_event(df.page))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="JTc1U5jALfOR" data-outputId="eed1da5b-b441-410a-b7df-d9f06cac58f9">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">1</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="26">
<pre><code>[Row(artist=&#39;Martha Tilston&#39;, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=50, lastName=&#39;Freeman&#39;, length=277.89016, level=&#39;paid&#39;, location=&#39;Bakersfield, CA&#39;, method=&#39;PUT&#39;, page=&#39;NextSong&#39;, registration=1538173362000, sessionId=29, song=&#39;Rockpools&#39;, status=200, ts=1538352117000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0&#39;, userId=&#39;30&#39;, churn=0)]</code></pre>
</div>
</div>
<div class="cell markdown" id="1ohPr0yGLfOR">
<p>As show in <code>df.head(1)</code>, the 'churn' column has been
successfully added to the dataframe, and a value of 0 has been assigned
for the specified userId. To proceed, we can sort our records for a
given userId in reverse time order and calculate the sum of values in
the 'churn' column. This will help us understand the user's churn
behavior over time.</p>
</div>
<div class="cell code" id="-wmZ6ZnPLfOS">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a window specification for each user ordered by timestamp in reverse</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>windowval <span class="op">=</span> Window.partitionBy(<span class="st">&quot;userId&quot;</span>).orderBy(desc(<span class="st">&quot;ts&quot;</span>)).rangeBetween(Window.unboundedPreceding, <span class="dv">0</span>)</span></code></pre></div>
</div>
<div class="cell code" id="Or3Q58LRLfOd">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;churn&#39; column containing the sum of &#39;churn&#39; values over records</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">&quot;churn&quot;</span>, Fsum(<span class="st">&quot;churn&quot;</span>).over(windowval))</span></code></pre></div>
</div>
<div class="cell code" id="jzQM5T7MLfOd">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;churn&#39; to get counts</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>df_churn <span class="op">=</span> df.select([<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;churn&#39;</span>]).dropDuplicates().groupBy(<span class="st">&#39;churn&#39;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="iHaj2oTULfOd" data-outputId="f8189ebc-ed85-4c8f-b55e-7ec62390647a">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_churn.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+-----+
|churn|count|
+-----+-----+
|    0|  123|
|    1|   15|
+-----+-----+

</code></pre>
</div>
</div>
<section
id="exploratory-data-analysis-for-users-that-stayed-vs-users-that-churned"
class="cell markdown" id="B70GKIErLfOe">
<h3>Exploratory Data Analysis for Users that Stayed vs Users that
Churned</h3>
</section>
<div class="cell markdown" id="Ya7g3mhDLfOe">
<p>Let's explore and visualize the behavior of users who churned
compared to those who stayed.</p>
</div>
<div class="cell code" id="1M8Ca0V8LfOe">
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to pandas for visualisation</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>df_churn <span class="op">=</span> df_churn.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="IsT0SNi-LfOf" data-outputId="69c1da0d-d75d-4cc1-ee27-66ffa08cc265">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the number of users who churned</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>df_churn, x<span class="op">=</span><span class="st">&#39;churn&#39;</span>, y<span class="op">=</span><span class="st">&#39;count&#39;</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Number of Users Who Churned&quot;</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Churn&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="32">
<pre><code>Text(0.5, 0, &#39;Churn&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/501e1c46c6af75c7e6d84efbb9d24b98a6a2e719.png" /></p>
</div>
</div>
<div class="cell markdown" id="ZKiHP1a3LfOf">
<p>The above visualization reveals that 173 users chose to stay, while
52 users decided to churn. Consequently, it's worth noting that
approximately 23% of our users churned. It's important to recognize that
this represents an imbalance in our user population, which can be a
significant consideration for future analysis and modeling.</p>
</div>
<section id="duration-of-engagement-churned-users-vs-retained-users"
class="cell markdown" id="CTndGssdLfOg">
<h3>Duration of Engagement: Churned Users vs. Retained Users</h3>
<p>Now, let's examine the distribution of engagement duration for both
retained and churned customers.</p>
</section>
<div class="cell code" id="sYo8mJC4LfOg">
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get churned customers</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>df_churned <span class="op">=</span> df.<span class="bu">filter</span>(df.churn <span class="op">==</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="cell code" id="y_UOauU2LfOg">
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to pandas</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>churned_pd <span class="op">=</span> df_churned.toPandas()</span></code></pre></div>
</div>
<div class="cell code" id="WJyWfL0SLfOg">
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the nulls</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>churned_pd.length.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:497}"
id="NKTQd18NLfOg" data-outputId="2ddeb016-31aa-4966-d7c5-287d355feeab">
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of engagement duration</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>bin_edges <span class="op">=</span> np.arange(<span class="dv">10</span>, churned_pd[<span class="st">&#39;length&#39;</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">25</span>, <span class="dv">25</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>plt.hist(data<span class="op">=</span>churned_pd, x<span class="op">=</span><span class="st">&#39;length&#39;</span>, bins<span class="op">=</span>bin_edges)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, <span class="dv">700</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Length&#39;</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Frequency&#39;</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Distribution of Engagement Duration for Churned Users&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="36">
<pre><code>Text(0.5, 1.0, &#39;Distribution of Engagement Duration for Churned Users&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/37725c74e3f10672ebe3d6a249039ea20c27470a.png" /></p>
</div>
</div>
<div class="cell markdown" id="zfgF2UCzLfOh">
<p>Do the same for Retained Users</p>
</div>
<div class="cell code" id="GDCsx_moLfOh">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get churned customers</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>df_retained <span class="op">=</span> df.<span class="bu">filter</span>(df.churn <span class="op">==</span> <span class="dv">0</span>)</span></code></pre></div>
</div>
<div class="cell code" id="sVexpvl4LfOh">
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to pandas</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>retained_pd <span class="op">=</span> df_retained.toPandas()</span></code></pre></div>
</div>
<div class="cell code" id="e7BZ_PPWLfOi">
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the nulls</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>retained_pd.length.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:497}"
id="4bmFVgrALfOi" data-outputId="2239d205-b824-4dbe-f991-b7dea6fd7004">
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of engagement duration</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>bin_edges <span class="op">=</span> np.arange(<span class="dv">10</span>, retained_pd[<span class="st">&#39;length&#39;</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">25</span>, <span class="dv">25</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>plt.hist(data<span class="op">=</span>retained_pd, x<span class="op">=</span><span class="st">&#39;length&#39;</span>, bins<span class="op">=</span>bin_edges)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, <span class="dv">700</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Length&#39;</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Frequency&#39;</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Distribution of Engagement Duration for Retained Users&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="40">
<pre><code>Text(0.5, 1.0, &#39;Distribution of Engagement Duration for Retained Users&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/9fd45dffd843aaa83afdc63a9a9fd21d0b158a74.png" /></p>
</div>
</div>
<div class="cell markdown" id="-jsb4yW0LfOi">
<p>As observed in the previous plots, the distribution of engagement
duration appears quite similar for both churned and retained users.
Therefore, this feature may not be particularly informative for
predicting customer churn.</p>
</div>
<section id="subscription-level-churned-users-vs-retained-users"
class="cell markdown" id="ORW7hZ8TLfOj">
<h3>Subscription Level: Churned Users vs. Retained Users</h3>
</section>
<div class="cell code" id="y0PFm46DLfOj">
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the level dataframe</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>df_level <span class="op">=</span> df.select([<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;churn&#39;</span>, <span class="st">&#39;level&#39;</span>]).dropDuplicates().groupBy(<span class="st">&#39;level&#39;</span>,<span class="st">&#39;churn&#39;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="DbQFIG67LfOj" data-outputId="177250de-0f2f-4408-94aa-da4403a5578d">
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show number of users of Churned Users vs. Retained Users group by Subcription level</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>df_level.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+-----+-----+
|level|churn|count|
+-----+-----+-----+
| free|    0|  104|
| paid|    0|   73|
| free|    1|   13|
| paid|    1|   13|
+-----+-----+-----+

</code></pre>
</div>
</div>
<div class="cell code" id="pqHE4IsILfOk">
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to pandas</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>df_level <span class="op">=</span> df_level.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="igv3alibLfOk" data-outputId="c16c74d6-291f-42b7-c09f-27ec98bee0f5">
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the barplot using seaborn</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>df_level, x<span class="op">=</span><span class="st">&#39;churn&#39;</span>, y<span class="op">=</span><span class="st">&#39;count&#39;</span>, hue<span class="op">=</span><span class="st">&#39;level&#39;</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="dv">1</span>, ncol<span class="op">=</span><span class="dv">2</span>, framealpha<span class="op">=</span><span class="dv">1</span>, title<span class="op">=</span><span class="st">&#39;Level&#39;</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Number of Users Who Churned vs. Stayed by Subscription Level&quot;</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Churn&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="44">
<pre><code>Text(0.5, 0, &#39;Churn&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/be4c69ffbeb8c53af39eb20f06240ec2ab31d090.png" /></p>
</div>
</div>
<div class="cell markdown" id="WMxu19rSLfOl">
<p>The chart above illustrates that users who utilized the free service
tier were slightly more prone to churn, with a churn rate of
approximately 23.6%(46/(46+149)), compared to users who subscribed to
the paid tier, which had a churn rate of approximately
21.8%(36/(129+36))</p>
</div>
<section id="pages-visited-by-churned-users-vs-retained-users"
class="cell markdown" id="8acdM2r7LfOl">
<h3>Pages Visited by Churned Users vs. Retained Users</h3>
</section>
<div class="cell markdown" id="lTDnOlzhLfOl">
<p>Next, let's investigate whether there were variations in the pages
visited by users who churned compared to those who stayed.</p>
</div>
<div class="cell code" id="MoUD5H9ELfOl">
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df_page <span class="op">=</span> df.select([<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;churn&#39;</span>, <span class="st">&#39;page&#39;</span>]).groupBy(<span class="st">&#39;page&#39;</span>,<span class="st">&#39;churn&#39;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="tjwgQlgRLfOm" data-outputId="ba76e788-1c86-4d3d-8f45-276f27d87074">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>df_page.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+--------------------+-----+-----+
|                page|churn|count|
+--------------------+-----+-----+
|            Settings|    0|  369|
|         Thumbs Down|    1|  115|
|           Thumbs Up|    1|  523|
|     Add to Playlist|    1|  309|
|               Error|    1|   10|
|               About|    1|   17|
|         Thumbs Down|    0|  522|
|         Roll Advert|    1|  148|
|                Home|    0| 2634|
|Cancellation Conf...|    1|   15|
|               Error|    0|   73|
|              Cancel|    1|   15|
|            Settings|    1|   86|
|          Add Friend|    1|  200|
|             Upgrade|    0|  169|
|           Downgrade|    1|  109|
|              Logout|    1|  165|
|    Submit Downgrade|    1|    1|
|       Save Settings|    0|   77|
|           Thumbs Up|    0| 2830|
+--------------------+-----+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="FOIA4MFvLfOm">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to pandas</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>df_page <span class="op">=</span> df_page.toPandas()</span></code></pre></div>
</div>
<div class="cell code" id="dX8d0gvCLfOm">
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create page visit counts for churned and retained users</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>churn_count <span class="op">=</span> df_page[df_page[<span class="st">&#39;churn&#39;</span>] <span class="op">==</span> <span class="dv">1</span>].<span class="bu">sum</span>()</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>stay_count <span class="op">=</span> df_page[df_page[<span class="st">&#39;churn&#39;</span>] <span class="op">==</span> <span class="dv">0</span>].<span class="bu">sum</span>()</span></code></pre></div>
</div>
<div class="cell markdown" id="ayijKZB1LfOn">
<p>Now that we have counted the number of customers who churned and
those who stayed, we can calculate the rate and add it as a column in
our DataFrame.</p>
</div>
<div class="cell code" id="LM5vAMQNLfOn">
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>df_page[<span class="st">&#39;rate&#39;</span>] <span class="op">=</span> np.where(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    df_page[<span class="st">&#39;churn&#39;</span>] <span class="op">==</span> <span class="dv">0</span>, df_page[<span class="st">&#39;count&#39;</span>] <span class="op">/</span> stay_count[<span class="st">&#39;count&#39;</span>],</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    np.where(df_page[<span class="st">&#39;churn&#39;</span>] <span class="op">==</span> <span class="dv">1</span>, df_page[<span class="st">&#39;count&#39;</span>] <span class="op">/</span> churn_count[<span class="st">&#39;count&#39;</span>], df_page[<span class="st">&#39;count&#39;</span>] <span class="op">/</span> churn_count[<span class="st">&#39;count&#39;</span>])</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="NEtvRFHZLfOo" data-outputId="e0903027-a23f-48b9-a016-0dc4f0a75851">
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df_page.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="50">

  <div id="df-2df945e9-407a-4999-9ab4-46617df7d318" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>page</th>
      <th>churn</th>
      <th>count</th>
      <th>rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Settings</td>
      <td>0</td>
      <td>369</td>
      <td>0.005370</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Thumbs Down</td>
      <td>1</td>
      <td>115</td>
      <td>0.008611</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Thumbs Up</td>
      <td>1</td>
      <td>523</td>
      <td>0.039161</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Add to Playlist</td>
      <td>1</td>
      <td>309</td>
      <td>0.023137</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Error</td>
      <td>1</td>
      <td>10</td>
      <td>0.000749</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2df945e9-407a-4999-9ab4-46617df7d318')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2df945e9-407a-4999-9ab4-46617df7d318 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2df945e9-407a-4999-9ab4-46617df7d318');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-25965271-588e-4d91-aad9-45d2d8bcecb7">
  <button class="colab-df-quickchart" onclick="quickchart('df-25965271-588e-4d91-aad9-45d2d8bcecb7')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-25965271-588e-4d91-aad9-45d2d8bcecb7 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:852}"
id="TVT8NJ5LLfOo" data-outputId="b7f9296a-8bc9-46f4-cac2-858faa40ac87">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the rate of pages visited by users who churned vs. those who stayed</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">20</span>, <span class="dv">16</span>])</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>sns.barplot(data<span class="op">=</span>df_page, x<span class="op">=</span><span class="st">&#39;rate&#39;</span>, y<span class="op">=</span><span class="st">&#39;page&#39;</span>, hue<span class="op">=</span><span class="st">&#39;churn&#39;</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Rate of Pages Navigated to by Users Who Churned vs. Users Who Stayed&#39;</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Rate&#39;</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Page&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="51">
<pre><code>Text(0, 0.5, &#39;Page&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/81fcad2826f55838c18a2d200db40c451593fa2e.png" /></p>
</div>
</div>
<div class="cell markdown" id="14cdhtQeLfOo">
<p>The chart above reveals some interesting patterns. Both users who
stayed and those who churned most frequently skipped to the next song.
However, churned users displayed a higher frequency of actions like
rolling advertisements and giving songs a thumbs-down. Conversely, users
who were more likely to stay exhibited higher engagement, as evidenced
by more frequent thumbs-up actions, adding friends, and adding songs to
their playlists.</p>
</div>
<section id="calculating-songs-per-hour" class="cell markdown"
id="Lxkz71nrLfOp">
<h4>Calculating Songs per Hour</h4>
</section>
<div class="cell markdown" id="jriEKdNOLfOp">
<p>Let's now focus on calculating the number of songs listened to by
both churned and non-churned users per hour.</p>
</div>
<div class="cell code" id="J_AIQEqdLfOp">
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to extract the hour from the timestamp</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>get_hour <span class="op">=</span> udf(<span class="kw">lambda</span> x: datetime.datetime.fromtimestamp(x <span class="op">/</span> <span class="fl">1000.0</span>).hour, IntegerType())</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;hour&#39; column</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">&quot;hour&quot;</span>, get_hour(df.ts))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="h1cnjzkcLfOq" data-outputId="25f02346-0f51-49b8-8f93-38de0905da54">
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check if column hour exist</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="53">
<pre><code>Row(artist=None, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=81, lastName=&#39;Larson&#39;, length=None, level=&#39;paid&#39;, location=&#39;Dallas-Fort Worth-Arlington, TX&#39;, method=&#39;GET&#39;, page=&#39;Home&#39;, registration=1537982255000, sessionId=1210, song=None, status=200, ts=1540395773000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0&#39;, userId=&#39;100&#39;, churn=0, hour=15)</code></pre>
</div>
</div>
<div class="cell markdown" id="H3DVTanBLfOq">
<p>For non-churned users, let's have a deep dive to see if their
habit</p>
</div>
<div class="cell code" id="BLqLI5RrLfOq">
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame for users who didn&#39;t churn and count &#39;NextSong&#39; page visits per hour</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_stay <span class="op">=</span> df.<span class="bu">filter</span>((df.page <span class="op">==</span> <span class="st">&quot;NextSong&quot;</span>) <span class="op">&amp;</span> (df.churn <span class="op">==</span> <span class="dv">0</span>)).groupby(df.hour).count().orderBy(df.hour.cast(<span class="st">&quot;float&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="jzRzUnO4LfOq" data-outputId="110e65e2-8a4f-4566-86e6-66c778fccca1">
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show distribution in 24 hours</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_stay.show(<span class="dv">24</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+----+-----+
|hour|count|
+----+-----+
|   0| 2235|
|   1| 1980|
|   2| 1922|
|   3| 1807|
|   4| 1866|
|   5| 2028|
|   6| 2067|
|   7| 2073|
|   8| 2071|
|   9| 2056|
|  10| 2114|
|  11| 2269|
|  12| 2470|
|  13| 2441|
|  14| 2552|
|  15| 2624|
|  16| 2787|
|  17| 2804|
|  18| 2801|
|  19| 2886|
|  20| 2843|
|  21| 2646|
|  22| 2595|
|  23| 2421|
+----+-----+

</code></pre>
</div>
</div>
<div class="cell code" id="D4QkTc_TLfOq">
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Pandas DataFrame and cast &#39;hour&#39; to numeric</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_stay_pd <span class="op">=</span> songs_in_hour_stay.toPandas()</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>songs_in_hour_stay_pd[<span class="st">&#39;hour&#39;</span>] <span class="op">=</span> pd.to_numeric(songs_in_hour_stay_pd[<span class="st">&#39;hour&#39;</span>])</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="Eyjw0olVLfOr" data-outputId="4b285fd8-0490-4058-e0b4-daa6eea64a64">
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of songs played per hour for non-churn users</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(songs_in_hour_stay_pd[<span class="st">&quot;hour&quot;</span>], songs_in_hour_stay_pd[<span class="st">&quot;count&quot;</span>])</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="dv">1</span>, <span class="dv">24</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Hour&quot;</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Songs Played&quot;</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Number of Songs Played per Hour (Non-Churn Users)&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="57">
<pre><code>Text(0.5, 1.0, &#39;Number of Songs Played per Hour (Non-Churn Users)&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/c0ce84e45c443171fa91d860d2204874c99d29fc.png" /></p>
</div>
</div>
<div class="cell markdown" id="sr3-_VEiLfOr">
<p>As observed in the previous plot, there is a peak in the number of
songs played between 3 pm and 8 pm for non-churn users. Next, we will
perform a similar analysis for users who churned.</p>
</div>
<div class="cell code" id="J0IPt6e3LfOr">
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame for users who didn&#39;t churn and count &#39;NextSong&#39; page visits per hour</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_churned <span class="op">=</span> df.<span class="bu">filter</span>((df.page <span class="op">==</span> <span class="st">&quot;NextSong&quot;</span>) <span class="op">&amp;</span> (df.churn <span class="op">==</span> <span class="dv">1</span>)).groupby(df.hour).count().orderBy(df.hour.cast(<span class="st">&quot;float&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="cjppRnxFLfOr" data-outputId="697e1cb0-b484-478f-cdb6-0b9089ca7406">
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show distribution in 24 hours</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_churned.show(<span class="dv">24</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+----+-----+
|hour|count|
+----+-----+
|   0|  442|
|   1|  445|
|   2|  485|
|   3|  514|
|   4|  489|
|   5|  491|
|   6|  488|
|   7|  433|
|   8|  403|
|   9|  429|
|  10|  488|
|  11|  449|
|  12|  409|
|  13|  437|
|  14|  461|
|  15|  505|
|  16|  476|
|  17|  490|
|  18|  477|
|  19|  420|
|  20|  437|
|  21|  457|
|  22|  437|
|  23|  458|
+----+-----+

</code></pre>
</div>
</div>
<div class="cell code" id="NbIRqA_nLfOs">
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Pandas DataFrame and cast &#39;hour&#39; to numeric</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>songs_in_hour_churned <span class="op">=</span> songs_in_hour_churned.toPandas()</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>songs_in_hour_churned.hour <span class="op">=</span> pd.to_numeric(songs_in_hour_churned.hour)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="eu2NqeWjLfOs" data-outputId="37eb9d9c-a704-4728-f480-558548443a28">
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of songs played per hour for users who churned</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(songs_in_hour_churned[<span class="st">&quot;hour&quot;</span>], songs_in_hour_churned[<span class="st">&quot;count&quot;</span>])</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="dv">1</span>, <span class="dv">24</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Hour&quot;</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Songs Played&quot;</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Number of Songs Played per Hour (Users Who Churned)&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="61">
<pre><code>Text(0.5, 1.0, &#39;Number of Songs Played per Hour (Users Who Churned)&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/f9d1be20de2538211ef982fd5b57df4aecaf710e.png" /></p>
</div>
</div>
<div class="cell markdown" id="IpiKCm_RLfOs">
<p>It's evident that users who churned exhibited a similar distribution
of song playback throughout the day. However, in comparison to users who
remained, churned users listened to a lower number of songs per
hour.</p>
</div>
<section id="songs-per-session-for-churned-users-vs-retained-users"
class="cell markdown" id="mtfwsu3ULfOs">
<h3>Songs per Session for Churned Users vs. Retained Users</h3>
<p>To visualize the average songs per session for both churned and
retained users, we can create a bar chart that allows for a
straightforward comparison between the two groups.</p>
</section>
<div class="cell code" id="g3Sj6mJQLfOt">
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>df_songs <span class="op">=</span> df.<span class="bu">filter</span>(df.page <span class="op">==</span> <span class="st">&quot;NextSong&quot;</span>).dropDuplicates().groupBy(<span class="st">&#39;sessionId&#39;</span>,<span class="st">&#39;churn&#39;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="GiSd5HI-LfOt" data-outputId="44f0609a-532b-4173-c289-e49b6fab17df">
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get average grouped by churn</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>df_songs.groupby(<span class="st">&#39;churn&#39;</span>).agg({<span class="st">&quot;count&quot;</span>:<span class="st">&quot;avg&quot;</span>}).show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+-----------------+
|churn|       avg(count)|
+-----+-----------------+
|    0|67.57553956834532|
|    1|90.32786885245902|
+-----+-----------------+

</code></pre>
</div>
</div>
<div class="cell code" id="BrCe-zwWLfOt">
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>df_songs <span class="op">=</span> df_songs.groupby(<span class="st">&#39;churn&#39;</span>).agg({<span class="st">&quot;count&quot;</span>:<span class="st">&quot;avg&quot;</span>})</span></code></pre></div>
</div>
<div class="cell code" id="u4aI7L1sLfOu">
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to Pandas</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>df_songs <span class="op">=</span> df_songs.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="ZlOIqsFeLfOu" data-outputId="edfb32d1-8011-4bb6-cecd-84059867b1b5">
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the average number of songs played per session for users who churned and those who stayed</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>df_songs, x<span class="op">=</span><span class="st">&#39;churn&#39;</span>, y<span class="op">=</span><span class="st">&#39;avg(count)&#39;</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Average Number of Songs Played per Session for Churned Users vs. Retained Users&quot;</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Average Number of Songs Played Per Session&quot;</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Churn&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="66">
<pre><code>Text(0.5, 0, &#39;Churn&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/033699afa2e0d724b5b2c2f5ae735b48622e447e.png" /></p>
</div>
</div>
<div class="cell markdown" id="bFE_d4iKLfOv">
<p>The chart clearly illustrates that users who churned from Sparkify
tended to listen to fewer songs on average per session compared to those
who stayed.</p>
</div>
<section id="number-of-unique-artists-listened-to" class="cell markdown"
id="-ilfW4NbLfOv">
<h3>Number of Unique Artists Listened to</h3>
<p>We can create a similar chart to visualize the number of unique
artists that users listened to.</p>
</section>
<div class="cell code" id="W1gcba_BLfOv">
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame to count the number of unique artists per user and their churn status</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>df_artists <span class="op">=</span> df.select(<span class="st">&quot;artist&quot;</span>, <span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).dropDuplicates().groupby(<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="rY9x7g3nLfOv" data-outputId="537bcffa-cdcc-4981-850f-6125a53ef3cb">
<div class="sourceCode" id="cb95"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average number of unique artists per user for churned and non-churned users</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>df_artists.groupby(<span class="st">&#39;churn&#39;</span>).agg({<span class="st">&quot;count&quot;</span>: <span class="st">&quot;avg&quot;</span>}).show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+-----------------+
|churn|       avg(count)|
+-----+-----------------+
|    0|360.1138211382114|
|    1|552.0666666666667|
+-----+-----------------+

</code></pre>
</div>
</div>
<div class="cell code" id="70-myq5VLfOv">
<div class="sourceCode" id="cb97"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to Pandas</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>df_artists <span class="op">=</span> df_artists.toPandas()</span></code></pre></div>
</div>
<div class="cell markdown" id="lpJFUkuLLfOv">
<p>Let's create a boxplot to visualize the maximum and median values for
the number of unique artists listened to by both churned and non-churned
users.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="MBIoaiCVLfOw" data-outputId="09375418-58bc-49c4-c3c9-7d6686fdfa0a">
<div class="sourceCode" id="cb98"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a boxplot to compare the number of artists listened to by churned and non-churned users</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.boxplot(data<span class="op">=</span>df_artists, x<span class="op">=</span><span class="st">&#39;churn&#39;</span>, y<span class="op">=</span><span class="st">&#39;count&#39;</span>)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Number of Artists Listened to on Sparkify&quot;</span>)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Churn&quot;</span>)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="70">
<pre><code>Text(0, 0.5, &#39;Count&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/0d8fd9bd27f79adb444223f65927dcfb5e9486b7.png" /></p>
</div>
</div>
<div class="cell markdown" id="a76JvT3ULfOw">
<p>The boxplot above clearly illustrates that users who didn't churn
tended to listen to a larger number of different artists compared to
those who churned.</p>
</div>
<section id="location" class="cell markdown" id="JaCt-waRLfOw">
<h3>Location</h3>
<p>We want to see if location can be a feature decide which user is
churned or not</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="a804NQ0yLfOw" data-outputId="172147cf-9be6-4fa8-a2f5-a375b646698d">
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the relevant columns, group by location, and count the number of users in each location</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">&quot;location&quot;</span>, <span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).groupby(<span class="st">&quot;location&quot;</span>).count().show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+--------------------+-----+
|            location|count|
+--------------------+-----+
|     Gainesville, FL|  928|
|Atlantic City-Ham...|  318|
|Deltona-Daytona B...|   54|
|San Diego-Carlsba...|   44|
|Kingsport-Bristol...| 1150|
|New Haven-Milford...|  318|
|  Corpus Christi, TX|   11|
|         Dubuque, IA|  124|
|Las Vegas-Henders...|  362|
|Indianapolis-Carm...|  934|
|Seattle-Tacoma-Be...|  149|
|   Winston-Salem, NC|  621|
|     Bakersfield, CA|  512|
|Los Angeles-Long ...|11120|
|Minneapolis-St. P...|  226|
|San Francisco-Oak...| 1055|
|Phoenix-Mesa-Scot...| 2320|
|Allentown-Bethleh...|  250|
|Miami-Fort Lauder...| 1712|
|           Selma, AL| 2027|
+--------------------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="WuWNYQ_mLfOw">
<p>We can see that two last characters in the location string is the
state of that location so we should extract it to enrich our data.</p>
</div>
<div class="cell code" id="rojJ5i-eLfOw">
<div class="sourceCode" id="cb102"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to extract the state from the location</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>get_state <span class="op">=</span> udf(<span class="kw">lambda</span> x: x[<span class="op">-</span><span class="dv">2</span>:])</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column &#39;state&#39; containing the extracted state information</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>df_state <span class="op">=</span> df.withColumn(<span class="st">&quot;state&quot;</span>, get_state(df.location))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="gFa7PwSNLfOx" data-outputId="a7a2787f-2712-49e4-9125-412db130348a">
<div class="sourceCode" id="cb103"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># double check</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>df_state.head(<span class="dv">1</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="73">
<pre><code>[Row(artist=None, auth=&#39;Logged In&#39;, firstName=&#39;Colin&#39;, gender=&#39;M&#39;, itemInSession=81, lastName=&#39;Larson&#39;, length=None, level=&#39;paid&#39;, location=&#39;Dallas-Fort Worth-Arlington, TX&#39;, method=&#39;GET&#39;, page=&#39;Home&#39;, registration=1537982255000, sessionId=1210, song=None, status=200, ts=1540395773000, userAgent=&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0&#39;, userId=&#39;100&#39;, churn=0, hour=15, state=&#39;TX&#39;)]</code></pre>
</div>
</div>
<div class="cell code" id="Q6PJPWp7LfOx">
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame to count the number of users per state and their churn status</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>df_state <span class="op">=</span> df_state.select(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).dropDuplicates().groupby(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;churn&quot;</span>).count()</span></code></pre></div>
</div>
<div class="cell code" id="f3d4B1tMLfOx">
<div class="sourceCode" id="cb106"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to Pandas</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>df_state_pd <span class="op">=</span> df_state.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:939}"
id="D7KbYCvtLfOx" data-outputId="2dc458ce-670b-4f7f-e1fd-3e0a980b0135">
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the count of users who churned vs. those who stayed by US state</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">20</span>, <span class="dv">16</span>])</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>sns.barplot(data<span class="op">=</span>df_state_pd, x<span class="op">=</span><span class="st">&#39;count&#39;</span>, y<span class="op">=</span><span class="st">&#39;state&#39;</span>, hue<span class="op">=</span><span class="st">&#39;churn&#39;</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Count of Users Who Churned vs. Users Who Stayed by US State&#39;</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Count&#39;</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;US State&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="76">
<pre><code>Text(0, 0.5, &#39;US State&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/0e6399823f9d1a8c5662a1c4970ae24fbaaf9fea.png" /></p>
</div>
</div>
<div class="cell markdown" id="HoXYScZZLfOx">
<p>The majority of users were based in California (CA). Interestingly,
in states like Michigan (MI), Kentucky (KY), and Ohio (OH), more users
churned than stayed. Creating a useful feature from this information for
modeling might be challenging. Let's set this aside for now and shift
our focus to another column in our dataset: operating systems and
browsers.</p>
</div>
<section id="useragent-operating-system-and-browsers"
class="cell markdown" id="IsAAlJXnLfOx">
<h3>UserAgent: Operating System and Browsers</h3>
</section>
<div class="cell code" id="vYRe-AcBLfOx">
<div class="sourceCode" id="cb109"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the relevant columns and drop duplicate rows based on &#39;userId&#39;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>df_opsys <span class="op">=</span> df.select(<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;userAgent&quot;</span>, <span class="st">&quot;churn&quot;</span>).dropDuplicates([<span class="st">&#39;userId&#39;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="WAuEIr7_LfOy">
<div class="sourceCode" id="cb110"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to Pandas</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>df_opsys <span class="op">=</span> df_opsys.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="xecuKsgiLfOy" data-outputId="8cf79b62-c5b3-42a0-b78b-5bc96fa12f03">
<div class="sourceCode" id="cb111"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the possible list of operating systems and their counts</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>df_opsys.userAgent.value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="79">
<pre><code>&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                16
Mozilla/5.0 (Windows NT 6.1; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0                                                                       15
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                     12
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                     10
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.77.4 (KHTML, like Gecko) Version/7.0.5 Safari/537.77.4&quot;                         8
&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                                 5
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.78.2 (KHTML, like Gecko) Version/7.0.6 Safari/537.78.2&quot;                         5
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36&quot;                       5
&quot;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                 5
Mozilla/5.0 (Windows NT 6.3; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0                                                                        4
Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:31.0) Gecko/20100101 Firefox/31.0                                                               4
&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36&quot;                                  3
Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko                                                                            3
&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53&quot;     3
&quot;Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                        3
&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.103 Safari/537.36&quot;                                 3
&quot;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                                 3
&quot;Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                 2
Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0)                                                                          2
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                      1
Mozilla/5.0 (Windows NT 6.1; WOW64; rv:32.0) Gecko/20100101 Firefox/32.0                                                                        1
Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:31.0) Gecko/20100101 Firefox/31.0                                                               1
Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0                                                                            1
Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:31.0) Gecko/20100101 Firefox/31.0                                                               1
&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 7_1_1 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D201 Safari/9537.53&quot;     1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                      1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10) AppleWebKit/600.1.3 (KHTML, like Gecko) Version/8.0 Safari/600.1.3&quot;                              1
Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0                                                                               1
&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                                     1
&quot;Mozilla/5.0 (iPad; CPU OS 7_1_2 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D257 Safari/9537.53&quot;              1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.75.14 (KHTML, like Gecko) Version/7.0.3 Safari/537.75.14&quot;                       1
&quot;Mozilla/5.0 (iPad; CPU OS 7_1_1 like Mac OS X) AppleWebKit/537.51.2 (KHTML, like Gecko) Version/7.0 Mobile/11D201 Safari/9537.53&quot;              1
&quot;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                        1
Mozilla/5.0 (Windows NT 6.0; rv:31.0) Gecko/20100101 Firefox/31.0                                                                               1
Mozilla/5.0 (Windows NT 6.1; WOW64; rv:24.0) Gecko/20100101 Firefox/24.0                                                                        1
&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36&quot;                                     1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.74.9 (KHTML, like Gecko) Version/7.0.2 Safari/537.74.9&quot;                         1
Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0                                                                        1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.76.4 (KHTML, like Gecko) Version/7.0.4 Safari/537.76.4&quot;                         1
Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:31.0) Gecko/20100101 Firefox/31.0                                                                      1
Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0                                                                    1
&quot;Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                                 1
&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36&quot;                       1
&quot;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&quot;                                        1
Mozilla/5.0 (Windows NT 6.2; WOW64; rv:31.0) Gecko/20100101 Firefox/31.0                                                                        1
Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)                                                                         1
Name: userAgent, dtype: int64</code></pre>
</div>
</div>
<div class="cell code" id="dRQecLhILfOy">
<div class="sourceCode" id="cb113"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create list of OS</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>os_list <span class="op">=</span> [<span class="st">&quot;Windows&quot;</span>, <span class="st">&quot;Mac&quot;</span>, <span class="st">&quot;Linux&quot;</span>, <span class="st">&quot;iPhone&quot;</span>, <span class="st">&quot;iPad&quot;</span>]</span></code></pre></div>
</div>
<div class="cell code" id="hpr-_VTlLfOy">
<div class="sourceCode" id="cb114"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;os&#39; column and extract strings that match the os_list and add them to the column</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>df_opsys[<span class="st">&#39;os&#39;</span>] <span class="op">=</span> df_opsys.userAgent.<span class="bu">str</span>.extract(<span class="st">&#39;(?i)(</span><span class="sc">{0}</span><span class="st">)&#39;</span>.<span class="bu">format</span>(<span class="st">&#39;|&#39;</span>.join(os_list)))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="O8OGQtUQLfOy" data-outputId="dab93bf2-531b-497a-f7ed-0e4b3cee62f6">
<div class="sourceCode" id="cb115"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check that worked</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>df_opsys.head(<span class="dv">5</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="82">

  <div id="df-9c1d8d37-b775-4665-b3a9-32ba1b3d775d" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>userAgent</th>
      <th>churn</th>
      <th>os</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4...</td>
      <td>0</td>
      <td>Mac</td>
    </tr>
    <tr>
      <th>1</th>
      <td>100</td>
      <td>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) G...</td>
      <td>0</td>
      <td>Windows</td>
    </tr>
    <tr>
      <th>2</th>
      <td>101</td>
      <td>Mozilla/5.0 (Windows NT 6.2; WOW64; rv:31.0) G...</td>
      <td>1</td>
      <td>Windows</td>
    </tr>
    <tr>
      <th>3</th>
      <td>102</td>
      <td>"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebK...</td>
      <td>0</td>
      <td>Windows</td>
    </tr>
    <tr>
      <th>4</th>
      <td>103</td>
      <td>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_4...</td>
      <td>0</td>
      <td>Mac</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-9c1d8d37-b775-4665-b3a9-32ba1b3d775d')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-9c1d8d37-b775-4665-b3a9-32ba1b3d775d button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-9c1d8d37-b775-4665-b3a9-32ba1b3d775d');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-d7e76974-d013-4046-a3e1-2d8e8cc29622">
  <button class="colab-df-quickchart" onclick="quickchart('df-d7e76974-d013-4046-a3e1-2d8e8cc29622')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-d7e76974-d013-4046-a3e1-2d8e8cc29622 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="wesNnt6eLfOy" data-outputId="9893b4f7-c6bc-415d-849c-49dd1477dd70">
<div class="sourceCode" id="cb116"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the statics of OS column</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>df_opsys.os.value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="83">
<pre><code>Windows    74
Mac        53
Linux       5
iPhone      4
iPad        2
Name: os, dtype: int64</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:744}"
id="5v0c3w-3LfOy" data-outputId="b1c86439-6e5b-4ed1-91f0-bb2de6436def">
<div class="sourceCode" id="cb118"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the count of users who churned vs. those who stayed by operating system</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">10</span>, <span class="dv">8</span>])</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>sns.countplot(data<span class="op">=</span>df_opsys, x<span class="op">=</span><span class="st">&#39;os&#39;</span>, hue<span class="op">=</span><span class="st">&#39;churn&#39;</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Count of Users Who Churned vs. Users Who Stayed by Operating System&#39;</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Operating System&#39;</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="dv">1</span>, ncol<span class="op">=</span><span class="dv">2</span>, framealpha<span class="op">=</span><span class="dv">1</span>, title<span class="op">=</span><span class="st">&#39;Churn&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="84">
<pre><code>&lt;matplotlib.legend.Legend at 0x78eb2e68cd90&gt;</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/1e8546255fcb20c8d04da7f49db512d831206f7b.png" /></p>
</div>
</div>
<div class="cell markdown" id="W7HhgLKILfOz">
<p>Among the operating systems, Windows was the most commonly used.
Interestingly, Linux users had the highest rate of churn. However, this
impact is limited to very few customers, and as such, it won't be a
significant factor in our modeling efforts. We can do it the same with
browsers.</p>
</div>
<div class="cell code" id="tH6LcbhBLfOz">
<div class="sourceCode" id="cb120"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#define browser list</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>browser_list <span class="op">=</span> [<span class="st">&quot;Opera&quot;</span>, <span class="st">&quot;Microsoft Edge&quot;</span>, <span class="st">&quot;Vivaldi&quot;</span>, <span class="st">&quot;Internet Explorer&quot;</span>, <span class="st">&quot;Brave&quot;</span>, <span class="st">&quot;UC Browser&quot;</span>, <span class="st">&quot;Chrome&quot;</span>, <span class="st">&quot;Firefox&quot;</span>, <span class="st">&quot;Safari&quot;</span>, <span class="st">&quot;Trident&quot;</span>]</span></code></pre></div>
</div>
<div class="cell code" id="__9gh1ZcLfOz">
<div class="sourceCode" id="cb121"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new column browser from userAgent column</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>df_opsys[<span class="st">&#39;browser&#39;</span>] <span class="op">=</span> df_opsys.userAgent.<span class="bu">str</span>.extract(<span class="st">&#39;(?i)(</span><span class="sc">{0}</span><span class="st">)&#39;</span>.<span class="bu">format</span>(<span class="st">&#39;|&#39;</span>.join(browser_list)))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="ZKn9Qw53LfOz" data-outputId="719389a1-dc13-43f2-e0e4-0c00277a447b">
<div class="sourceCode" id="cb122"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># count number of records base on browser</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>df_opsys.browser.value_counts()</span></code></pre></div>
<div class="output execute_result" data-execution_count="87">
<pre><code>Chrome     75
Firefox    34
Safari     23
Trident     6
Name: browser, dtype: int64</code></pre>
</div>
</div>
<div class="cell markdown" id="Xzi6O4Q1LfOz">
<p>Here, "Trident" refers to Internet Explorer software. Let's replace
"Trident" with "Internet Explorer," as it is more commonly
recognized.</p>
</div>
<div class="cell code" id="VjcUM9-6LfOz">
<div class="sourceCode" id="cb124"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replace &quot;Trident&quot; records with &quot;Internet Explorer&quot;</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>df_opsys[<span class="st">&#39;browser&#39;</span>].replace({<span class="st">&quot;Trident&quot;</span>: <span class="st">&quot;Internet Explorer&quot;</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:727}"
id="5l9dzag9LfOz" data-outputId="2df1ae69-6d90-4a73-da3f-d7218b56574c">
<div class="sourceCode" id="cb125"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">8</span>])</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>sns.countplot(data <span class="op">=</span> df_opsys, x <span class="op">=</span> <span class="st">&#39;browser&#39;</span>, hue <span class="op">=</span><span class="st">&#39;churn&#39;</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Count of Churned Users vs. Retained Users by Browser&#39;</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>plt.legend(loc <span class="op">=</span> <span class="dv">1</span>, ncol <span class="op">=</span> <span class="dv">2</span>, framealpha <span class="op">=</span><span class="dv">1</span>, title <span class="op">=</span> <span class="st">&#39;level&#39;</span>)<span class="op">;</span></span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/6e8ffa98f807d213978b4c1dc9ae1c5391b9f8f8.png" /></p>
</div>
</div>
<div class="cell markdown" id="Mxdu7JJdLfO0">
<ul>
<li>Chrome emerged as the most popular browser among users.</li>
<li>Firefox users exhibited a higher likelihood of churning.</li>
<li>Internet Explorer had the lowest number of users who churned.</li>
<li>There doesn't appear to be a clear association between browser
choice and user churn. Consequently, this feature may not be a
significant predictor for our churn prediction model.</li>
</ul>
</div>
<section id="days-since-registration-for-sparkify" class="cell markdown"
id="-rA3Z9MZLfO0">
<h3>Days Since Registration for Sparkify</h3>
<p>Let's take a look at the number of days since a user had
registered</p>
</section>
<div class="cell code" id="8sUuWEouLfO0">
<div class="sourceCode" id="cb126"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select relevant columns, remove duplicates, and sort by &#39;userId&#39;</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>df_days <span class="op">=</span> df.select([<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;registration&#39;</span>, <span class="st">&#39;ts&#39;</span>, <span class="st">&#39;churn&#39;</span>]).dropDuplicates().sort(<span class="st">&#39;userId&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="3zqrCSVOLfO0">
<div class="sourceCode" id="cb127"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Order by last timestamp within each user&#39;s data</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> Window.partitionBy(<span class="st">&quot;userId&quot;</span>).orderBy(desc(<span class="st">&quot;ts&quot;</span>))</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a rank column with the most recent timestamp as rank number 1</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>df_days <span class="op">=</span> df_days.withColumn(<span class="st">&quot;Rank&quot;</span>, dense_rank().over(w))</span></code></pre></div>
</div>
<div class="cell code" id="DldpgSGaLfO0">
<div class="sourceCode" id="cb128"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># just get those with a rank of 1 i.e the first rows</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>df_days <span class="op">=</span> df_days.<span class="bu">filter</span>(df_days.Rank <span class="op">==</span> <span class="dv">1</span>).drop(df_days.Rank)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="-EPUBYgALfO0" data-outputId="9d4174d4-6823-4807-a1f7-9e15a8f05907">
<div class="sourceCode" id="cb129"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>df_days.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-------------+-------------+-----+
|userId| registration|           ts|churn|
+------+-------------+-------------+-----+
|    10|1538159495000|1539926798000|    0|
|   100|1537982255000|1540395773000|    0|
|   101|1535066380000|1539729037000|    1|
|   102|1537915702000|1539772333000|    0|
|   103|1537699856000|1540080480000|    0|
|   104|1532498424000|1540350730000|    0|
|   105|1536817381000|1539375441000|    1|
|   106|1537679535000|1540395758000|    0|
|   107|1536303841000|1539179853000|    0|
|   108|1538215963000|1540393421000|    0|
|   109|1534768517000|1540458806000|    0|
|    11|1532554781000|1539569675000|    0|
|   110|1537665002000|1538487558000|    0|
|   111|1536372490000|1539663641000|    0|
|   112|1536032681000|1540410364000|    0|
|   113|1532920994000|1540060314000|    0|
|   114|1536831228000|1540452235000|    0|
|   115|1536948181000|1540458742000|    0|
|   117|1537142824000|1539183980000|    0|
|   118|1537893493000|1540394576000|    0|
+------+-------------+-------------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="GHYunNeTLfO0">
<div class="sourceCode" id="cb131"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the time difference in days by subtracting &#39;registration&#39; from &#39;ts&#39;</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>df_days <span class="op">=</span> df_days.withColumn(<span class="st">&quot;delta_days&quot;</span>, (df_days[<span class="st">&#39;ts&#39;</span>]) <span class="op">-</span> (df_days[<span class="st">&#39;registration&#39;</span>]))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="RrwK0XveLfO1" data-outputId="ec373b50-880e-4782-fa20-31cbeab10c1e">
<div class="sourceCode" id="cb132"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>df_days.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-------------+-------------+-----+----------+
|userId| registration|           ts|churn|delta_days|
+------+-------------+-------------+-----+----------+
|    10|1538159495000|1539926798000|    0|1767303000|
|   100|1537982255000|1540395773000|    0|2413518000|
|   101|1535066380000|1539729037000|    1|4662657000|
|   102|1537915702000|1539772333000|    0|1856631000|
|   103|1537699856000|1540080480000|    0|2380624000|
|   104|1532498424000|1540350730000|    0|7852306000|
|   105|1536817381000|1539375441000|    1|2558060000|
|   106|1537679535000|1540395758000|    0|2716223000|
|   107|1536303841000|1539179853000|    0|2876012000|
|   108|1538215963000|1540393421000|    0|2177458000|
|   109|1534768517000|1540458806000|    0|5690289000|
|    11|1532554781000|1539569675000|    0|7014894000|
|   110|1537665002000|1538487558000|    0| 822556000|
|   111|1536372490000|1539663641000|    0|3291151000|
|   112|1536032681000|1540410364000|    0|4377683000|
|   113|1532920994000|1540060314000|    0|7139320000|
|   114|1536831228000|1540452235000|    0|3621007000|
|   115|1536948181000|1540458742000|    0|3510561000|
|   117|1537142824000|1539183980000|    0|2041156000|
|   118|1537893493000|1540394576000|    0|2501083000|
+------+-------------+-------------+-----+----------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="3_8zozckLfO1">
<div class="sourceCode" id="cb134"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the time difference to days</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>df_days <span class="op">=</span> df_days.withColumn(<span class="st">&#39;days&#39;</span>, (df_days[<span class="st">&#39;delta_days&#39;</span>] <span class="op">/</span> <span class="dv">1000</span> <span class="op">/</span> <span class="dv">3600</span> <span class="op">/</span> <span class="dv">24</span>))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="lJtM_kpmLfO1" data-outputId="4186f820-acef-4cfe-ab1c-7c8fdb459685">
<div class="sourceCode" id="cb135"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>df_days.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-------------+-------------+-----+----------+------------------+
|userId| registration|           ts|churn|delta_days|              days|
+------+-------------+-------------+-----+----------+------------------+
|    10|1538159495000|1539926798000|    0|1767303000|20.454895833333335|
|   100|1537982255000|1540395773000|    0|2413518000|27.934236111111108|
|   101|1535066380000|1539729037000|    1|4662657000|53.965937499999995|
|   102|1537915702000|1539772333000|    0|1856631000| 21.48878472222222|
|   103|1537699856000|1540080480000|    0|2380624000| 27.55351851851852|
|   104|1532498424000|1540350730000|    0|7852306000| 90.88317129629628|
|   105|1536817381000|1539375441000|    1|2558060000|29.607175925925926|
|   106|1537679535000|1540395758000|    0|2716223000|31.437766203703703|
|   107|1536303841000|1539179853000|    0|2876012000| 33.28717592592593|
|   108|1538215963000|1540393421000|    0|2177458000|25.202060185185186|
|   109|1534768517000|1540458806000|    0|5690289000| 65.85982638888889|
|    11|1532554781000|1539569675000|    0|7014894000| 81.19090277777778|
|   110|1537665002000|1538487558000|    0| 822556000| 9.520324074074074|
|   111|1536372490000|1539663641000|    0|3291151000|38.092025462962965|
|   112|1536032681000|1540410364000|    0|4377683000|50.667627314814816|
|   113|1532920994000|1540060314000|    0|7139320000| 82.63101851851852|
|   114|1536831228000|1540452235000|    0|3621007000| 41.90980324074074|
|   115|1536948181000|1540458742000|    0|3510561000| 40.63149305555556|
|   117|1537142824000|1539183980000|    0|2041156000| 23.62449074074074|
|   118|1537893493000|1540394576000|    0|2501083000|28.947719907407407|
+------+-------------+-------------+-----+----------+------------------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="H16MaBKiLfO1">
<p>The dataframe is looking good, now let's convert it to Pandas and
visualize.</p>
</div>
<div class="cell code" id="C-50DbrVLfO1">
<div class="sourceCode" id="cb137"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to Pandas</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>df_days_pd <span class="op">=</span> df_days.toPandas()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:590}"
id="NF-QLWitLfO1" data-outputId="d619d406-bd46-423d-d230-63dd96553247">
<div class="sourceCode" id="cb138"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a boxplot to compare the distribution of days since registering for users who churned vs. those who stayed</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">6</span>])</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>sns.boxplot(data<span class="op">=</span>df_days_pd, x<span class="op">=</span><span class="st">&#39;churn&#39;</span>, y<span class="op">=</span><span class="st">&#39;days&#39;</span>)</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Distribution of Days Since Registering for Users Who Churned vs. Users Who Stayed&#39;</span>)</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Churn&quot;</span>)</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Days Since Registered&quot;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="99">
<pre><code>Text(0, 0.5, &#39;Days Since Registered&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/1ba0c4c89262a40d9c0478068d4842b4b3590d86.png" /></p>
</div>
</div>
<div class="cell markdown" id="jU7wWB85LfO1">
<p>On average, users who had been registered with Sparkify for a longer
duration were more likely to remain as active users. Conversely, users
who had registered more recently were more likely to churn, indicating a
potential correlation between the length of registration and user
retention.</p>
</div>
<section id="feature-engineering" class="cell markdown"
id="vO7NqdNeLfO2">
<h1>Feature Engineering</h1>
<p>Once you've familiarized yourself with the data, build out the
features you find promising to train your model on. To work with the
full dataset, you can follow the following steps.</p>
<ul>
<li>Write a script to extract the necessary features from the smaller
subset of data</li>
<li>Ensure that your script is scalable, using the best practices
discussed in Lesson 3</li>
<li>Try your script on the full data set, debugging your script if
necessary</li>
</ul>
<p>If you are working in the classroom workspace, you can just extract
features based on the small subset of data contained here. Be sure to
transfer over this work to the larger dataset when you work on your
Spark cluster.</p>
</section>
<section id="list-of-feature-that-we-have-performed-eda"
class="cell markdown" id="bWbc3FMYLfO2">
<h3>List of feature that we have performed EDA:</h3>
<h4 id="categorical-datatype">Categorical datatype:</h4>
<ul>
<li>level</li>
</ul>
<h4 id="numerical-datatype">Numerical datatype:</h4>
<ul>
<li>Number of songs per session</li>
<li>Number of roll ads actions</li>
<li>Number of thumb-down actions</li>
<li>Number of thumbs-up actions</li>
<li>Number of friends added</li>
<li>Number of songs added to playlist</li>
<li>Number of different artists listened to on Sparkify</li>
<li>Number of days since registering</li>
</ul>
</section>
<div class="cell markdown" id="Ll6LParOLfO2">
<p>We will also add a churn label and combine all these variables into a
single dataframe where each row corresponds to individual user
information. After dropping the userId column, this dataframe can be
preprocessed by converting categorical variables into numerical format,
making it ready for use in our machine learning algorithms.</p>
</div>
<section id="level" class="cell markdown" id="NimSfRVPLfO2">
<h3>Level</h3>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="1qnC5G6eLfO2" data-outputId="0bfa109a-939f-47d9-94c8-8a5ae3ad76f5">
<div class="sourceCode" id="cb140"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select userId, level, ts(we will use this column to get the latest level)</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>df_level_f <span class="op">=</span> df.select([<span class="st">&#39;userId&#39;</span>, <span class="st">&#39;level&#39;</span>, <span class="st">&#39;ts&#39;</span>]).dropDuplicates().sort(<span class="st">&#39;userId&#39;</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>df_level_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-----+-------------+
|userId|level|           ts|
+------+-----+-------------+
|    10| paid|1538976032000|
|    10| paid|1538970428000|
|    10| paid|1538978423000|
|    10| paid|1538970868000|
|    10| paid|1538972430000|
|    10| paid|1538973109000|
|    10| paid|1538969362000|
|    10| paid|1538969534000|
|    10| paid|1538970605000|
|    10| paid|1538968748000|
|    10| paid|1538979188000|
|    10| paid|1538976842000|
|    10| paid|1538974236000|
|    10| paid|1538971441000|
|    10| paid|1538976290000|
|    10| paid|1538967509000|
|    10| paid|1538967243000|
|    10| paid|1538977038000|
|    10| paid|1538967004000|
|    10| paid|1538966419000|
+------+-----+-------------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="hM4rw4UqLfO2">
<div class="sourceCode" id="cb142"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a window partition to get the latest rank</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> Window.partitionBy(<span class="st">&quot;userId&quot;</span>).orderBy(desc(<span class="st">&quot;ts&quot;</span>))</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column &quot;rank&quot;</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>df_level_f <span class="op">=</span> df_level_f.withColumn(<span class="st">&quot;Rank&quot;</span>, dense_rank().over(w))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="cP5kMkkRLfO3" data-outputId="665d265b-7d38-4e1a-9367-b00c510237c4">
<div class="sourceCode" id="cb143"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>df_level_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-----+-------------+----+
|userId|level|           ts|Rank|
+------+-----+-------------+----+
|    10| paid|1539926798000|   1|
|    10| paid|1539926719000|   2|
|    10| paid|1539926618000|   3|
|    10| paid|1539926470000|   4|
|    10| paid|1539926251000|   5|
|    10| paid|1539926007000|   6|
|    10| paid|1539926006000|   7|
|    10| paid|1539925840000|   8|
|    10| paid|1539925585000|   9|
|    10| paid|1539925344000|  10|
|    10| paid|1539925013000|  11|
|    10| paid|1539924819000|  12|
|    10| paid|1539924568000|  13|
|    10| paid|1539924412000|  14|
|    10| paid|1539924160000|  15|
|    10| paid|1539924004000|  16|
|    10| paid|1539923838000|  17|
|    10| paid|1539923706000|  18|
|    10| paid|1539923458000|  19|
|    10| paid|1539923260000|  20|
+------+-----+-------------+----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="SQuVAqxeLfO3">
<p>Now we only care about the latest level which mean rank = 1</p>
</div>
<div class="cell code" id="62CjxgMfLfO3">
<div class="sourceCode" id="cb145"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter with condition rank = 1 and drop rank and ts column</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>df_level_f <span class="op">=</span> df_level_f.<span class="bu">filter</span>(df_level_f.Rank <span class="op">==</span> <span class="dv">1</span>).drop(df_level_f.Rank).drop(df_level_f.ts)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="FQS-2zgmLfO3" data-outputId="479ff473-a88b-40f8-c010-1c8a6c8c05ac">
<div class="sourceCode" id="cb146"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>df_level_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-----+
|userId|level|
+------+-----+
|    10| paid|
|   100| paid|
|   101| paid|
|   102| free|
|   103| paid|
|   104| paid|
|   105| paid|
|   106| paid|
|   107| free|
|   108| free|
|   109| paid|
|    11| free|
|   110| free|
|   111| free|
|   112| free|
|   113| paid|
|   114| paid|
|   115| paid|
|   117| free|
|   118| paid|
+------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="RdsWN6k9LfO3">
<p>In ML, we can't use "paid"&amp;"free" as our input so we have to
covert it to numerical type</p>
</div>
<div class="cell code" id="HB1qaoiDLfO4">
<div class="sourceCode" id="cb148"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>df_level_f <span class="op">=</span> df_level_f.withColumn(<span class="st">&#39;level&#39;</span>, when(col(<span class="st">&#39;level&#39;</span>) <span class="op">==</span> <span class="st">&#39;paid&#39;</span>, <span class="dv">1</span>).otherwise(<span class="dv">0</span>))</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="xZsUwxXjLfO4" data-outputId="614a7ee3-34c4-4839-a5de-2af575f96957">
<div class="sourceCode" id="cb149"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>df_level_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-----+
|userId|level|
+------+-----+
|    10|    1|
|   100|    1|
|   101|    1|
|   102|    0|
|   103|    1|
|   104|    1|
|   105|    1|
|   106|    1|
|   107|    0|
|   108|    0|
|   109|    1|
|    11|    0|
|   110|    0|
|   111|    0|
|   112|    0|
|   113|    1|
|   114|    1|
|   115|    1|
|   117|    0|
|   118|    1|
+------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="m16YzwlaLfO4" data-outputId="c2d2e6f0-9677-42e3-8b0c-5f24bc2ca3a3">
<div class="sourceCode" id="cb151"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>df_level_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="107">
<pre><code>138</code></pre>
</div>
</div>
<section id="average-number-of-songs-per-session" class="cell markdown"
id="iHgl51IDLfO4">
<h3>Average Number of songs per session</h3>
</section>
<div class="cell code" id="qAmR40w6LfO4">
<div class="sourceCode" id="cb153"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f <span class="op">=</span> df.<span class="bu">filter</span>(df.page <span class="op">==</span> <span class="st">&quot;NextSong&quot;</span>).groupBy(<span class="st">&#39;userId&#39;</span>,<span class="st">&#39;sessionId&#39;</span>).count()</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="gs7OKILcLfO4" data-outputId="cda29760-b92e-4267-dd5d-115d85dfd6b9">
<div class="sourceCode" id="cb154"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f.show(<span class="dv">2</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+---------+-----+
|userId|sessionId|count|
+------+---------+-----+
|    92|      358|   57|
|    42|      433|   16|
+------+---------+-----+
only showing top 2 rows

</code></pre>
</div>
</div>
<div class="cell code" id="Nqmr8xnhLfO5">
<div class="sourceCode" id="cb156"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f <span class="op">=</span> df_song_per_session_f.groupby(<span class="st">&#39;userId&#39;</span>).agg({<span class="st">&quot;count&quot;</span>:<span class="st">&quot;avg&quot;</span>})</span></code></pre></div>
</div>
<div class="cell code" id="QM4yCmxILfO5">
<div class="sourceCode" id="cb157"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f <span class="op">=</span> df_song_per_session_f.withColumnRenamed(<span class="st">&quot;avg(count)&quot;</span>, <span class="st">&quot;avg_song&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="8rJEyOBfLfO5" data-outputId="81fc621f-b589-40c0-e733-47c14eb897d3">
<div class="sourceCode" id="cb158"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="112">
<pre><code>138</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="DN608dKLLfO6" data-outputId="383a68b7-d87f-4a00-cc03-312c1fe3c661">
<div class="sourceCode" id="cb160"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>df_song_per_session_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+------------------+
|userId|          avg_song|
+------+------------------+
|   125|               8.0|
|    51|             211.1|
|   124|             152.7|
|     7|             27.25|
|    15|           139.625|
|    54|             90.75|
|   132|              75.2|
|   101|             179.7|
|    11|              25.5|
|   138|              68.0|
|    29|              85.5|
|    69|             111.2|
|    42| 76.16666666666667|
|   112|              20.0|
|    87|             30.68|
|    73|62.833333333333336|
|    64|               1.0|
|     3|              30.5|
|    30|            51.125|
|   113|              70.9|
+------+------------------+
only showing top 20 rows

</code></pre>
</div>
</div>
<section id="number-of-roll-ads-actions" class="cell markdown"
id="gfmkx-6SLfO6">
<h3>Number of roll ads actions</h3>
</section>
<div class="cell markdown" id="WI2lobQeLfO6">
<p>Another feature to consider is the number of roll ad actions. Users
who churned tend to have a higher count of roll ad actions because free
users are shown ads, whereas paid subscribers are not.</p>
</div>
<div class="cell code" id="21rDUGWCLfO7">
<div class="sourceCode" id="cb162"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>df_rollad_f <span class="op">=</span> df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="trPmRKeSLfO9">
<div class="sourceCode" id="cb163"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to create a &#39;rollad&#39; column</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>rollad_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Roll Advert&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span></code></pre></div>
</div>
<div class="cell code" id="5huB-lFOLfO9">
<div class="sourceCode" id="cb164"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;rollad&#39; column</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>df_rollad_f <span class="op">=</span> df_rollad_f.withColumn(<span class="st">&quot;rollad&quot;</span>, rollad_event(<span class="st">&quot;page&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code" id="moaCv19ILfO_">
<div class="sourceCode" id="cb165"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;userId&#39; and calculate the sum of &#39;rollad&#39;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>df_rollad_f <span class="op">=</span> df_rollad_f.groupby(<span class="st">&#39;userId&#39;</span>).<span class="bu">sum</span>(<span class="st">&quot;rollad&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="P_o390xGLfPA">
<div class="sourceCode" id="cb166"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column to &quot;roll_ad&quot;</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>df_rollad_f <span class="op">=</span> df_rollad_f.withColumnRenamed(<span class="st">&quot;sum(rollad)&quot;</span>, <span class="st">&quot;roll_ad&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Ny9jRl2nLfPB" data-outputId="c2ff6913-458e-4a25-c453-e1e637378cb6">
<div class="sourceCode" id="cb167"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>df_rollad_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="119">
<pre><code>138</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Z2xH38OaLfPB" data-outputId="34255da9-6859-4adf-9e01-709c031ef239">
<div class="sourceCode" id="cb169"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>df_rollad_f.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-------+
|userId|roll_ad|
+------+-------+
|   125|      1|
|    51|      0|
|   124|      2|
|     7|     13|
|    54|     45|
|    15|      0|
|   132|      0|
|   101|      8|
|    11|      8|
|   138|     14|
|    29|     17|
|    69|      3|
|    42|     10|
|   112|      5|
|    87|     50|
|    73|      1|
|     3|      0|
|    30|     16|
|   113|      1|
|    34|      2|
+------+-------+
only showing top 20 rows

</code></pre>
</div>
</div>
<section id="number-of-thumb-down-actions" class="cell markdown"
id="wsm_ou9uLfPC">
<h3>Number of thumb down actions</h3>
<p>Another feature to consider adding to our feature dataframe is
"thumbs down" actions. Users who had previously churned tend to have a
higher count of "thumbs down" actions compared to those who stayed with
the service.</p>
</section>
<div class="cell code" id="ZqtX3fiQLfPD">
<div class="sourceCode" id="cb171"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select relavant columns from df</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>df_thumbdown_f <span class="op">=</span> df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="wfzfzzWwLfPD">
<div class="sourceCode" id="cb172"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to create a &#39;Thumbs Down&#39; column</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>thumddown_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Thumbs Down&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span></code></pre></div>
</div>
<div class="cell code" id="oT5yfykELfPE">
<div class="sourceCode" id="cb173"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;Thumbs Down&#39; column</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>df_thumbdown_f <span class="op">=</span> df_thumbdown_f.withColumn(<span class="st">&quot;Thumbs Down&quot;</span>, thumddown_event(<span class="st">&quot;page&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code" id="9lRUKvPtLfPF">
<div class="sourceCode" id="cb174"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;userId&#39; and calculate the sum of &#39;Thumbs Down&#39;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>df_thumbdown_f <span class="op">=</span> df_thumbdown_f.groupby(<span class="st">&#39;userId&#39;</span>).<span class="bu">sum</span>(<span class="st">&quot;Thumbs Down&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="aC6NW3P-LfPF">
<div class="sourceCode" id="cb175"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column to &quot;thumbs_down&quot;</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>df_thumbdown_f <span class="op">=</span> df_thumbdown_f.withColumnRenamed(<span class="st">&quot;sum(Thumbs Down)&quot;</span>, <span class="st">&quot;thumbs_down&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="IR29dyurLfPF" data-outputId="db8125b6-722f-42e9-9d3e-5655def2ed57">
<div class="sourceCode" id="cb176"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of rows in the dataframe</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>df_thumbdown_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="126">
<pre><code>138</code></pre>
</div>
</div>
<section id="number-of-thumbs-up-actions" class="cell markdown"
id="Z9wty8PFLfPI">
<h3>Number of thumbs up actions</h3>
<p>We can also consider adding "thumbs up" actions as a feature. Users
who have remained with the service tend to have a higher count of
"thumbs up" actions in their history.</p>
</section>
<div class="cell code" id="1rb61mXRLfPJ">
<div class="sourceCode" id="cb178"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select relavant columns from df</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>df_thumbsup_f <span class="op">=</span> df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="ybStZ0UHLfPJ">
<div class="sourceCode" id="cb179"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to create a &#39;Thumbs Up&#39; column</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>thumbsup_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Thumbs Up&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span></code></pre></div>
</div>
<div class="cell code" id="kXSx88QOLfPK">
<div class="sourceCode" id="cb180"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;Thumbs Up&#39; column</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>df_thumbsup_f <span class="op">=</span> df_thumbsup_f.withColumn(<span class="st">&quot;Thumbs Up&quot;</span>, thumbsup_event(<span class="st">&quot;page&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code" id="rfs6aoxyLfPK">
<div class="sourceCode" id="cb181"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;userId&#39; and calculate the sum of &#39;Thumbs Up&#39;</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>df_thumbsup_f <span class="op">=</span> df_thumbsup_f.groupby(<span class="st">&#39;userId&#39;</span>).<span class="bu">sum</span>(<span class="st">&quot;Thumbs Up&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="1HGrSn5WLfPK">
<div class="sourceCode" id="cb182"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column to &quot;thumbs_up&quot;</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>df_thumbsup_f <span class="op">=</span> df_thumbsup_f.withColumnRenamed(<span class="st">&quot;sum(Thumbs Up)&quot;</span>, <span class="st">&quot;thumbs_up&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="zpg_mKiSLfPL" data-outputId="a5ddac5a-cae2-4817-8867-1baff99ee1f0">
<div class="sourceCode" id="cb183"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of rows in the dataframe</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>df_thumbsup_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="132">
<pre><code>138</code></pre>
</div>
</div>
<section id="number-of-friends-added" class="cell markdown"
id="mGn0CT4pLfPM">
<h3>Number of friends added</h3>
</section>
<div class="cell markdown" id="79J8TL8qLfPM">
<p>Certainly, you can add "number of friends added" as a feature to your
dataframe. Users who added more friends in the past tend to be more
likely to stay with the app. Here's how you can do it:</p>
</div>
<div class="cell code" id="VMITGSnRLfPN">
<div class="sourceCode" id="cb185"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>df_friends_added_f <span class="op">=</span> df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="kd18u79ULfPN">
<div class="sourceCode" id="cb186"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to create an &#39;add_friend&#39; column</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>add_friend_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Add Friend&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span></code></pre></div>
</div>
<div class="cell code" id="mpbwIXpWLfPO">
<div class="sourceCode" id="cb187"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;add_friend&#39; column</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>df_friends_added_f <span class="op">=</span> df_friends_added_f.withColumn(<span class="st">&quot;add_friend&quot;</span>, add_friend_event(<span class="st">&quot;page&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code" id="wWCyJ4h1LfPO">
<div class="sourceCode" id="cb188"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;userId&#39; and calculate the sum of &#39;add_friend&#39;</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>df_friends_added_f <span class="op">=</span> df_friends_added_f.groupby(<span class="st">&#39;userId&#39;</span>).<span class="bu">sum</span>(<span class="st">&quot;add_friend&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="3h2XDzzHLfPO">
<div class="sourceCode" id="cb189"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column to &quot;add_friend&quot;</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>df_friends_added_f <span class="op">=</span> df_friends_added_f.withColumnRenamed(<span class="st">&quot;sum(add_friend)&quot;</span>, <span class="st">&quot;add_friend&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="-xpyY-aWLfPP" data-outputId="aeab1ff9-9af7-4200-c067-ce1607c05783">
<div class="sourceCode" id="cb190"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of rows in the dataframe</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>df_friends_added_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="138">
<pre><code>138</code></pre>
</div>
</div>
<section id="number-of-songs-added-to-playlist" class="cell markdown"
id="ajA0vOkxLfPQ">
<h3>Number of songs added to playlist</h3>
<p>Certainly, you can add "number of songs added to playlist" as a
feature to your dataframe. Users who added more songs to their playlists
in the past tend to be more likely to stay with the service.</p>
</section>
<div class="cell code" id="B2hVoDvXLfPQ">
<div class="sourceCode" id="cb192"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>df_playlist_songs_f <span class="op">=</span> df.select([<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;page&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="4uP0BQqhLfPR">
<div class="sourceCode" id="cb193"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a User-Defined Function (UDF) to create a &#39;Playlist&#39; column</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>add_playlist_event <span class="op">=</span> udf(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">&quot;Add to Playlist&quot;</span> <span class="cf">else</span> <span class="dv">0</span>, IntegerType())</span></code></pre></div>
</div>
<div class="cell code" id="uWYmw841LfPS">
<div class="sourceCode" id="cb194"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the &#39;Playlist&#39; column</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>df_playlist_songs_f <span class="op">=</span> df_playlist_songs_f.withColumn(<span class="st">&quot;Playlist&quot;</span>, add_playlist_event(<span class="st">&quot;page&quot;</span>))</span></code></pre></div>
</div>
<div class="cell code" id="M2FRrhx3LfPT">
<div class="sourceCode" id="cb195"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by &#39;userId&#39; and calculate the sum of &#39;Playlist&#39;</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>df_playlist_songs_f <span class="op">=</span> df_playlist_songs_f.groupby(<span class="st">&#39;userId&#39;</span>).<span class="bu">sum</span>(<span class="st">&quot;Playlist&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="5-U3SzMDLfPT">
<div class="sourceCode" id="cb196"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column to &quot;playlist&quot;</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>df_playlist_songs_f <span class="op">=</span> df_playlist_songs_f.withColumnRenamed(<span class="st">&quot;sum(Playlist)&quot;</span>, <span class="st">&quot;playlist&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Emop-tbfLfPU" data-outputId="9fd25034-7590-4443-ade6-366c41bf654b">
<div class="sourceCode" id="cb197"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of rows in the dataframe</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>df_playlist_songs_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="144">
<pre><code>138</code></pre>
</div>
</div>
<section id="count-of-unique-artists-listened-to-on-sparkify"
class="cell markdown" id="V2TQ2fa-LfPV">
<h3>Count of Unique Artists Listened to on Sparkify</h3>
</section>
<div class="cell code" id="wZTOwBipLfPW">
<div class="sourceCode" id="cb199"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>df_artists_f <span class="op">=</span> df.select(<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;artist&quot;</span>).dropDuplicates().groupby(<span class="st">&quot;userId&quot;</span>).count()</span></code></pre></div>
</div>
<div class="cell code" id="ki0mRliJLfPW">
<div class="sourceCode" id="cb200"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>df_artists_f <span class="op">=</span> df_artists_f.withColumnRenamed(<span class="st">&quot;count&quot;</span>, <span class="st">&quot;num_artists&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="co2imRY5LfPW" data-outputId="70a45f9b-5b32-4e38-c501-d76ebfb0fb0b">
<div class="sourceCode" id="cb201"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>df_artists_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="147">
<pre><code>138</code></pre>
</div>
</div>
<section id="number-of-days-since-registering" class="cell markdown"
id="JDdVQDOMLfPX">
<h3>Number of Days Since Registering</h3>
<p>"Number of Days Since Registration" also appeared to be a valuable
feature during our Exploratory Data Analysis (EDA). Our findings
indicated that users with a shorter duration since registering were more
likely to churn compared to those who had been using the service for a
longer period.</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="w3VZt_wTLfPX" data-outputId="8f8189d2-f7c9-4ed0-e2d8-4e1ab13e756a">
<div class="sourceCode" id="cb203"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>df_days.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-------------+-------------+-----+----------+------------------+
|userId| registration|           ts|churn|delta_days|              days|
+------+-------------+-------------+-----+----------+------------------+
|    10|1538159495000|1539926798000|    0|1767303000|20.454895833333335|
|   100|1537982255000|1540395773000|    0|2413518000|27.934236111111108|
|   101|1535066380000|1539729037000|    1|4662657000|53.965937499999995|
|   102|1537915702000|1539772333000|    0|1856631000| 21.48878472222222|
|   103|1537699856000|1540080480000|    0|2380624000| 27.55351851851852|
|   104|1532498424000|1540350730000|    0|7852306000| 90.88317129629628|
|   105|1536817381000|1539375441000|    1|2558060000|29.607175925925926|
|   106|1537679535000|1540395758000|    0|2716223000|31.437766203703703|
|   107|1536303841000|1539179853000|    0|2876012000| 33.28717592592593|
|   108|1538215963000|1540393421000|    0|2177458000|25.202060185185186|
|   109|1534768517000|1540458806000|    0|5690289000| 65.85982638888889|
|    11|1532554781000|1539569675000|    0|7014894000| 81.19090277777778|
|   110|1537665002000|1538487558000|    0| 822556000| 9.520324074074074|
|   111|1536372490000|1539663641000|    0|3291151000|38.092025462962965|
|   112|1536032681000|1540410364000|    0|4377683000|50.667627314814816|
|   113|1532920994000|1540060314000|    0|7139320000| 82.63101851851852|
|   114|1536831228000|1540452235000|    0|3621007000| 41.90980324074074|
|   115|1536948181000|1540458742000|    0|3510561000| 40.63149305555556|
|   117|1537142824000|1539183980000|    0|2041156000| 23.62449074074074|
|   118|1537893493000|1540394576000|    0|2501083000|28.947719907407407|
+------+-------------+-------------+-----+----------+------------------+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="Oyq93w5VLfPX">
<div class="sourceCode" id="cb205"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>df_days_f <span class="op">=</span> df_days.drop(<span class="st">&#39;registration&#39;</span>, <span class="st">&#39;ts&#39;</span>, <span class="st">&#39;churn&#39;</span>, <span class="st">&#39;delta_days&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="kqOjDJsCLfPY" data-outputId="4705631a-5394-465b-e552-e6bd94035914">
<div class="sourceCode" id="cb206"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>df_days_f.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="150">
<pre><code>138</code></pre>
</div>
</div>
<section id="label" class="cell markdown" id="XmVk6SxZLfPY">
<h3>Label</h3>
</section>
<div class="cell markdown" id="YsZof9mZLfPZ">
<p>Now, we can create our label column to indicate whether the user
churned (1) or not (0).</p>
</div>
<div class="cell code" id="Cvm0ihzOLfPZ">
<div class="sourceCode" id="cb208"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> df.select(<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).dropDuplicates().groupby(<span class="st">&quot;userId&quot;</span>, <span class="st">&quot;churn&quot;</span>).count()</span></code></pre></div>
</div>
<div class="cell code" id="wbq1-kgdLfPZ">
<div class="sourceCode" id="cb209"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> label.drop(<span class="st">&#39;count&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="OrOALTZRLfPa" data-outputId="c8c19a2c-82be-43c7-843b-5ef60b8ba618">
<div class="sourceCode" id="cb210"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>label.count()</span></code></pre></div>
<div class="output execute_result" data-execution_count="153">
<pre><code>138</code></pre>
</div>
</div>
<div class="cell code" id="1brqtKFALfPa">
<div class="sourceCode" id="cb212"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> label.withColumnRenamed(<span class="st">&quot;churn&quot;</span>, <span class="st">&quot;label&quot;</span>)</span></code></pre></div>
</div>
<section id="create-final-dataset" class="cell markdown"
id="rykE4iPnLfPb">
<h3>Create final dataset</h3>
</section>
<div class="cell markdown" id="ZmPL1BHtLfPb">
<p>Now that we have our features, we need to join them together based on
the <code>userId</code></p>
</div>
<div class="cell code" id="VKI2n3WOLfPb">
<div class="sourceCode" id="cb213"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> df_level_f.join(df_song_per_session_f, [<span class="st">&quot;userId&quot;</span>]).join(df_rollad_f, [<span class="st">&quot;userId&quot;</span>]).join(df_thumbdown_f, [<span class="st">&quot;userId&quot;</span>]).join(df_thumbsup_f, [<span class="st">&quot;userId&quot;</span>]).join(df_friends_added_f, [<span class="st">&quot;userId&quot;</span>]).join(df_playlist_songs_f, [<span class="st">&quot;userId&quot;</span>]).join(df_artists_f, [<span class="st">&quot;userId&quot;</span>]).join(df_days_f, [<span class="st">&quot;userId&quot;</span>]).join(label, [<span class="st">&quot;userId&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="IP_O4VceLfPc" data-outputId="5b903dd8-1cee-4a79-b967-f27223d26ca3">
<div class="sourceCode" id="cb214"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>final_df.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+------+-----+------------------+-------+-----------+---------+----------+--------+-----------+------------------+-----+
|userId|level|          avg_song|roll_ad|thumbs_down|thumbs_up|add_friend|playlist|num_artists|              days|label|
+------+-----+------------------+-------+-----------+---------+----------+--------+-----------+------------------+-----+
|    10|    1|             219.0|      0|          4|       26|         8|       8|        392|20.454895833333335|    0|
|   100|    1|              99.3|      1|         11|       49|        21|      26|        758|27.934236111111108|    0|
|   101|    1|             179.7|      8|         16|       86|        29|      61|       1242|53.965937499999995|    1|
|   102|    0|              30.0|      9|          1|        4|         0|       0|         60| 21.48878472222222|    0|
|   103|    1| 99.28571428571429|     14|          5|       29|        15|      30|        578| 27.55351851851852|    0|
|   104|    1|              50.3|     21|          1|       23|         6|      11|        426| 90.88317129629628|    0|
|   105|    1|             152.8|      2|          6|       45|        13|      12|        625|29.607175925925926|    1|
|   106|    1|              71.0|      4|          3|       32|        19|      16|        476|31.437766203703703|    0|
|   107|    0|              86.5|     10|          2|        9|         2|       9|        160| 33.28717592592593|    0|
|   108|    0|              51.0|     17|          1|        5|         3|       3|         95|25.202060185185186|    0|
|   109|    1|              45.0|      4|          1|        5|         3|       5|        242| 65.85982638888889|    0|
|    11|    0|              25.5|      8|          1|        8|         0|       2|        100| 81.19090277777778|    0|
|   110|    0|              31.0|      5|          0|        3|         0|       0|         31| 9.520324074074074|    0|
|   111|    0|12.666666666666666|      1|          0|        0|         6|       0|         36|38.092025462962965|    0|
|   112|    0|              20.0|      5|          1|        2|         1|       2|         78|50.667627314814816|    0|
|   113|    1|              70.9|      1|          4|       33|        18|      21|        565| 82.63101851851852|    0|
|   114|    1|              43.0|      8|          1|       14|         3|       7|        195| 41.90980324074074|    0|
|   115|    1|             237.5|     11|         13|       53|        13|      29|        735| 40.63149305555556|    0|
|   117|    0|              34.8|     12|          1|        7|         7|       3|        162| 23.62449074074074|    0|
|   118|    1|             129.0|     25|          7|       41|        20|      31|        701|28.947719907407407|    0|
+------+-----+------------------+-------+-----------+---------+----------+--------+-----------+------------------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell markdown" id="Kux8iZWILfPc">
<p>The column userId won't have any value in ML so we should drop
it.</p>
</div>
<div class="cell code" id="wfn8V3JVLfPd">
<div class="sourceCode" id="cb216"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> final_df.drop(<span class="st">&#39;userId&#39;</span>)</span></code></pre></div>
</div>
<section id="preprocessing" class="cell markdown" id="SmW5etY0LfPd">
<h3>Preprocessing</h3>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="0pGU115ILfPd" data-outputId="5c190fc4-56a8-4302-bbc5-6d25cfd09c48">
<div class="sourceCode" id="cb217"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print schema</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>final_df.printSchema()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>root
 |-- level: integer (nullable = false)
 |-- avg_song: double (nullable = true)
 |-- roll_ad: long (nullable = true)
 |-- thumbs_down: long (nullable = true)
 |-- thumbs_up: long (nullable = true)
 |-- add_friend: long (nullable = true)
 |-- playlist: long (nullable = true)
 |-- num_artists: long (nullable = false)
 |-- days: double (nullable = true)
 |-- label: long (nullable = true)

</code></pre>
</div>
</div>
<div class="cell code" id="3zKkTi3TLfPe">
<div class="sourceCode" id="cb219"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_to_float_column(df):</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Description: This function is used to convert all column in a dataframe to float for ML</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Input: original dataframe</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Ouput: dataframe with float datatype for all columns in it</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> df.columns:</span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.withColumn(feature, df[feature].cast(<span class="st">&#39;float&#39;</span>))</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="IqAXYildLfPe" data-outputId="99ff70c9-776e-42a5-f6be-ccdd3683de1d">
<div class="sourceCode" id="cb220"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first preprocessing</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> convert_to_float_column(final_df)</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print schema</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>final_df.printSchema()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>root
 |-- level: float (nullable = false)
 |-- avg_song: float (nullable = true)
 |-- roll_ad: float (nullable = true)
 |-- thumbs_down: float (nullable = true)
 |-- thumbs_up: float (nullable = true)
 |-- add_friend: float (nullable = true)
 |-- playlist: float (nullable = true)
 |-- num_artists: float (nullable = false)
 |-- days: float (nullable = true)
 |-- label: float (nullable = true)

</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="PDgEndyxLfPe" data-outputId="fb190cbc-848c-4954-cf85-15d494caf5ee">
<div class="sourceCode" id="cb222"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>final_df.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+---------+-------+-----------+---------+----------+--------+-----------+---------+-----+
|level| avg_song|roll_ad|thumbs_down|thumbs_up|add_friend|playlist|num_artists|     days|label|
+-----+---------+-------+-----------+---------+----------+--------+-----------+---------+-----+
|  1.0|    219.0|    0.0|        4.0|     26.0|       8.0|     8.0|      392.0|20.454895|  0.0|
|  1.0|     99.3|    1.0|       11.0|     49.0|      21.0|    26.0|      758.0|27.934237|  0.0|
|  1.0|    179.7|    8.0|       16.0|     86.0|      29.0|    61.0|     1242.0| 53.96594|  1.0|
|  0.0|     30.0|    9.0|        1.0|      4.0|       0.0|     0.0|       60.0|21.488785|  0.0|
|  1.0| 99.28571|   14.0|        5.0|     29.0|      15.0|    30.0|      578.0|27.553518|  0.0|
|  1.0|     50.3|   21.0|        1.0|     23.0|       6.0|    11.0|      426.0| 90.88317|  0.0|
|  1.0|    152.8|    2.0|        6.0|     45.0|      13.0|    12.0|      625.0|29.607176|  1.0|
|  1.0|     71.0|    4.0|        3.0|     32.0|      19.0|    16.0|      476.0|31.437767|  0.0|
|  0.0|     86.5|   10.0|        2.0|      9.0|       2.0|     9.0|      160.0|33.287174|  0.0|
|  0.0|     51.0|   17.0|        1.0|      5.0|       3.0|     3.0|       95.0| 25.20206|  0.0|
|  1.0|     45.0|    4.0|        1.0|      5.0|       3.0|     5.0|      242.0|65.859825|  0.0|
|  0.0|     25.5|    8.0|        1.0|      8.0|       0.0|     2.0|      100.0|  81.1909|  0.0|
|  0.0|     31.0|    5.0|        0.0|      3.0|       0.0|     0.0|       31.0| 9.520324|  0.0|
|  0.0|12.666667|    1.0|        0.0|      0.0|       6.0|     0.0|       36.0|38.092026|  0.0|
|  0.0|     20.0|    5.0|        1.0|      2.0|       1.0|     2.0|       78.0|50.667625|  0.0|
|  1.0|     70.9|    1.0|        4.0|     33.0|      18.0|    21.0|      565.0| 82.63102|  0.0|
|  1.0|     43.0|    8.0|        1.0|     14.0|       3.0|     7.0|      195.0|  41.9098|  0.0|
|  1.0|    237.5|   11.0|       13.0|     53.0|      13.0|    29.0|      735.0|40.631493|  0.0|
|  0.0|     34.8|   12.0|        1.0|      7.0|       7.0|     3.0|      162.0| 23.62449|  0.0|
|  1.0|    129.0|   25.0|        7.0|     41.0|      20.0|    31.0|      701.0| 28.94772|  0.0|
+-----+---------+-------+-----------+---------+----------+--------+-----------+---------+-----+
only showing top 20 rows

</code></pre>
</div>
</div>
<div class="cell code" id="Y_5d8olVLfPf">
<div class="sourceCode" id="cb224"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<div class="cell code" id="Mrh9WV8YLfPf">
<div class="sourceCode" id="cb225"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<div class="cell code" id="yABve97hLfPf">
<div class="sourceCode" id="cb226"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<section id="vector-assembler" class="cell markdown" id="B5KLdoBdLfPf">
<h3>Vector Assembler</h3>
<p>The purpose of the vector assembler is to convert our individual
features into a single feature vector. This vector can then be
standardized and utilized as input for our selected machine learning
algorithms.</p>
</section>
<div class="cell code" id="ukUu0ZCRLfPg">
<div class="sourceCode" id="cb227"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the input columns and output column</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>input_cols <span class="op">=</span> [<span class="st">&quot;level&quot;</span>, <span class="st">&quot;avg_song&quot;</span>, <span class="st">&quot;roll_ad&quot;</span>, <span class="st">&quot;thumbs_down&quot;</span>, <span class="st">&quot;thumbs_up&quot;</span>, <span class="st">&quot;add_friend&quot;</span>, <span class="st">&quot;playlist&quot;</span>, <span class="st">&quot;num_artists&quot;</span>, <span class="st">&quot;days&quot;</span>]</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>output_col <span class="op">=</span> <span class="st">&quot;vec_features&quot;</span></span></code></pre></div>
</div>
<div class="cell code" id="O64a_dvuLfPg">
<div class="sourceCode" id="cb228"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a VectorAssembler</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>input_cols, outputCol<span class="op">=</span>output_col)</span></code></pre></div>
</div>
<div class="cell code" id="5oiM-6uoLfPh">
<div class="sourceCode" id="cb229"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform the feature dataframe</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> assembler.transform(final_df)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="mApEqf3yLfPh" data-outputId="2ebde713-03ee-4ecd-f310-a301296696a8">
<div class="sourceCode" id="cb230"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>final_df.printSchema()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>root
 |-- level: float (nullable = false)
 |-- avg_song: float (nullable = true)
 |-- roll_ad: float (nullable = true)
 |-- thumbs_down: float (nullable = true)
 |-- thumbs_up: float (nullable = true)
 |-- add_friend: float (nullable = true)
 |-- playlist: float (nullable = true)
 |-- num_artists: float (nullable = false)
 |-- days: float (nullable = true)
 |-- label: float (nullable = true)
 |-- vec_features: vector (nullable = true)

</code></pre>
</div>
</div>
<section id="standardisation" class="cell markdown" id="WBO2Ljn4LfPh">
<h3>Standardisation</h3>
<p>After vectorizing our features, the next crucial step is
standardization. Standardization is vital for our machine learning model
to prevent features with exceptionally high values from overwhelming the
results. It also ensures that each individual feature follows a standard
normal distribution, which is beneficial for model training.</p>
</section>
<div class="cell code" id="tCUmroAMLfPi">
<div class="sourceCode" id="cb232"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a StandardScaler</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler(inputCol<span class="op">=</span><span class="st">&quot;vec_features&quot;</span>, outputCol<span class="op">=</span><span class="st">&quot;features&quot;</span>, withStd<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code" id="Zuh9l3dRLfPi">
<div class="sourceCode" id="cb233"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the scaler model on the feature dataframe</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>scaler_model <span class="op">=</span> scaler.fit(final_df)</span></code></pre></div>
</div>
<div class="cell code" id="3Yvua-EZLfPi">
<div class="sourceCode" id="cb234"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform the final dataframe</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> scaler_model.transform(final_df)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="EljbvD9HLfPi" data-outputId="94704d1d-9b5b-4f68-e901-05232641698c">
<div class="sourceCode" id="cb235"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>final_df.head(<span class="dv">1</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="169">
<pre><code>[Row(level=1.0, avg_song=219.0, roll_ad=0.0, thumbs_down=4.0, thumbs_up=26.0, add_friend=8.0, playlist=8.0, num_artists=392.0, days=20.45489501953125, label=0.0, vec_features=DenseVector([1.0, 219.0, 0.0, 4.0, 26.0, 8.0, 8.0, 392.0, 20.4549]), features=DenseVector([2.0063, 3.8342, 0.0, 0.6754, 0.9324, 0.8621, 0.4763, 1.0684, 0.6462]))]</code></pre>
</div>
</div>
<section id="train-test-split" class="cell markdown" id="B0VPbNliLfPi">
<h3>Train test split</h3>
</section>
<div class="cell markdown" id="l8xXHlCpLfPi">
<p>Let's check how many records we have for each label</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="yLtKf9gMLfPj" data-outputId="ace12f54-ef1e-4361-fb7d-26d7523449fd">
<div class="sourceCode" id="cb237"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>final_df.groupby(<span class="st">&#39;label&#39;</span>).count().show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>+-----+-----+
|label|count|
+-----+-----+
|  1.0|   15|
|  0.0|  123|
+-----+-----+

</code></pre>
</div>
</div>
<div class="cell markdown" id="6cdrLqgiLfPj">
<p>The dataset split is in line with our expectations. To ensure
reproducibility, we will divide the data into training, testing, and
validation sets using a 60:20:20 ratio. We incorporate a seed in this
process, which remains consistent across different machine learning
models to guarantee the replicability of our results.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="zGcwjo7mLfPj" data-outputId="d41af421-fbfe-4f20-c2e6-02cc5e099854">
<div class="sourceCode" id="cb239"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting the dataset into training, testing, and validation sets with a 60:20:20 ratio and seed for reproducibility</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>train, test, valid <span class="op">=</span> final_df.randomSplit([<span class="fl">0.6</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">1996</span>)</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Displaying the counts for each dataset</span></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Training Dataset:&quot;</span>, train.count())</span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Test Dataset:&quot;</span>, test.count())</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Validation Dataset:&quot;</span>, valid.count())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Training Dataset: 78
Test Dataset: 30
Validation Dataset: 30
</code></pre>
</div>
</div>
<section id="modeling" class="cell markdown" id="WrH2pzdLLfPj">
<h1>Modeling</h1>
<p>Now that we've successfully created a DataFrame containing only
numeric variables for our features, the next step is to partition the
complete dataset into three distinct sets: training, testing, and
validation. Our objective is to assess the performance of various
machine learning classification algorithms, specifically:</p>
<ul>
<li>Logistic Regression</li>
<li>Random Forest Classifier</li>
<li>Gradient-Boosted Tree Classifier</li>
<li>Linear Support Vector Machine</li>
<li>Naive Bayes These algorithms are chosen because churn prediction
involves a binary classification task, where customers are categorized
as either churning (1) or staying (0) within a particular time
frame.</li>
</ul>
<h3 id="metrics">Metrics</h3>
<p>We will assess the performance of various machine learning models,
fine-tuning their parameters as needed. Our ultimate goal is to select
the most effective model based on test accuracy and report the outcomes
on the validation set. Given that churned users represent a relatively
small subset, we will employ the F1 score as the primary metric for
optimization. The F1 score combines precision and recall, offering a
more comprehensive evaluation of model performance than the accuracy
metric. It is especially well-suited for addressing imbalanced class
issues, which are present in our dataset.</p>
<p>Let's proceed with the modeling phase. Once we identify the model
with the highest F1 score, accuracy, and efficiency, we will proceed to
fine-tune it.</p>
<p>The selected models and their justifications are as follows:</p>
<ul>
<li><p>Logistic Regression: We begin with logistic regression as it is a
dependable choice for binary classification problems. It offers good
interpretability and simplicity, making it a suitable starting point.
Logistic regression is also less prone to overfitting.</p></li>
<li><p>Random Forest: Random Forest is a powerful ensemble method for
classification. It constructs multiple decision trees and aggregates
their predictions, which can mitigate overfitting. Random Forest is
robust and performs well on imbalanced datasets like ours.</p></li>
<li><p>Gradient Boosted Tree Classifier: Gradient Boosted Trees provide
high predictive accuracy. It builds trees sequentially, with each new
tree correcting errors made by the previous one. While there's a risk of
overfitting, Gradient Boosted Trees excel with unbalanced data.</p></li>
<li><p>Linear Support Vector Machine (SVC): Linear SVC is another binary
classification algorithm that works effectively when clear class
separations exist. It is memory-efficient and can be a valuable addition
to our model lineup.</p></li>
<li><p>Naive Bayes: Finally, we consider Naive Bayes, which is easy to
implement and computationally efficient. It provides an alternative
approach to classification and can complement the other models in our
ensemble.</p></li>
</ul>
<p>Once we identify the best-performing model based on the specified
criteria, we will proceed with model tuning to further optimize its
performance.</p>
<h3 id="training-and-evaluating-model-performance">Training and
Evaluating Model Performance</h3>
<p>Here are the key steps in our model development process:</p>
<ul>
<li><p>Model Initialization: We start by creating instances of the
selected models.</p></li>
<li><p>Model Training: Next, we train these models using our training
data.</p></li>
<li><p>Prediction: After training, we use the trained models to make
predictions on our test data.</p></li>
<li><p>Performance Evaluation: Finally, we assess the performance of
these models based on predefined metrics and criteria.</p></li>
</ul>
</section>
<div class="cell code" id="myUnODp8LfPj">
<div class="sourceCode" id="cb241"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>logistic_regression_model <span class="op">=</span> LogisticRegression(featuresCol<span class="op">=</span><span class="st">&#39;features&#39;</span>, labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>, maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>random_forest_model <span class="op">=</span> RandomForestClassifier(featuresCol<span class="op">=</span><span class="st">&#39;features&#39;</span>, labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>, seed<span class="op">=</span><span class="dv">2023</span>)</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>gradient_boosted_tree_model <span class="op">=</span> GBTClassifier(featuresCol<span class="op">=</span><span class="st">&#39;features&#39;</span>, labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>, maxIter<span class="op">=</span><span class="dv">10</span>, seed<span class="op">=</span><span class="dv">2023</span>)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>linear_svc_model <span class="op">=</span> LinearSVC(featuresCol<span class="op">=</span><span class="st">&#39;features&#39;</span>, labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>)</span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>naive_bayes_model <span class="op">=</span> NaiveBayes(featuresCol<span class="op">=</span><span class="st">&#39;features&#39;</span>, labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="GLZsYeyTLfPk">
<div class="sourceCode" id="cb242"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>model_list <span class="op">=</span> [logistic_regression_model,random_forest_model,gradient_boosted_tree_model,linear_svc_model,naive_bayes_model]</span></code></pre></div>
</div>
<div class="cell code" id="Cj2KIN5zLfPk">
<div class="sourceCode" id="cb243"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the Evaluator for F1 Scores</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>f1_evaluator <span class="op">=</span> MulticlassClassificationEvaluator(labelCol<span class="op">=</span><span class="st">&#39;label&#39;</span>, predictionCol<span class="op">=</span><span class="st">&#39;prediction&#39;</span>)</span></code></pre></div>
</div>
<section id="compare-the-results-of-models-that-we-have-used"
class="cell markdown" id="KDmtZhhVRmw9">
<h3>Compare the results of models that we have used</h3>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="FL-d36eRLfPk" data-outputId="ee02194b-df7c-47b6-f67e-e20c313a59f5">
<div class="sourceCode" id="cb244"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterating through All Models and Evaluating</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> model_list:</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the model name</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> model.__class__.<span class="va">__name__</span></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print training start message</span></span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model_name, <span class="st">&#39;training started&#39;</span>)</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start time</span></span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the models on the training dataset</span></span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model.fit(train)</span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># End time</span></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> time.time()</span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print training completed message</span></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model_name, <span class="st">&#39;training completed&#39;</span>)</span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the time taken</span></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Time taken for </span><span class="sc">{}</span><span class="st"> is:&#39;</span>.<span class="bu">format</span>(model_name), (end <span class="op">-</span> start), <span class="st">&#39;seconds&#39;</span>)</span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict</span></span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model_name, <span class="st">&#39;prediction started&#39;</span>)</span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.transform(valid)</span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model_name, <span class="st">&#39;prediction completed&#39;</span>)</span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get metrics for evaluation</span></span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># F1 Score</span></span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a>    f1_score <span class="op">=</span> f1_evaluator.evaluate(predictions, {f1_evaluator.metricName: <span class="st">&quot;f1&quot;</span>})</span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;F1 Score for </span><span class="sc">{}</span><span class="st"> is:&#39;</span>.<span class="bu">format</span>(model_name), f1_score)</span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accuracy</span></span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> predictions.<span class="bu">filter</span>(predictions.label <span class="op">==</span> predictions.prediction).count() <span class="op">/</span> (predictions.count())</span>
<span id="cb244-36"><a href="#cb244-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Accuracy of the </span><span class="sc">{}</span><span class="st"> model is:&quot;</span>.<span class="bu">format</span>(model_name), accuracy)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>LogisticRegression training started
LogisticRegression training completed
Time taken for LogisticRegression is: 64.95849061012268 seconds
LogisticRegression prediction started
LogisticRegression prediction completed
F1 Score for LogisticRegression is: 0.7111111111111111
Accuracy of the LogisticRegression model is: 0.8
RandomForestClassifier training started
RandomForestClassifier training completed
Time taken for RandomForestClassifier is: 79.40840482711792 seconds
RandomForestClassifier prediction started
RandomForestClassifier prediction completed
F1 Score for RandomForestClassifier is: 0.7111111111111111
Accuracy of the RandomForestClassifier model is: 0.8
GBTClassifier training started
GBTClassifier training completed
Time taken for GBTClassifier is: 35.261269092559814 seconds
GBTClassifier prediction started
GBTClassifier prediction completed
F1 Score for GBTClassifier is: 0.7816711590296497
Accuracy of the GBTClassifier model is: 0.8333333333333334
LinearSVC training started
LinearSVC training completed
Time taken for LinearSVC is: 93.07376217842102 seconds
LinearSVC prediction started
LinearSVC prediction completed
F1 Score for LinearSVC is: 0.7111111111111111
Accuracy of the LinearSVC model is: 0.8
NaiveBayes training started
NaiveBayes training completed
Time taken for NaiveBayes is: 28.79982304573059 seconds
NaiveBayes prediction started
NaiveBayes prediction completed
F1 Score for NaiveBayes is: 0.7111111111111111
Accuracy of the NaiveBayes model is: 0.8
</code></pre>
</div>
</div>
<div class="cell markdown" id="ukx9x9OMR6lz">

</div>
<section id="model-tuning-for-optimal-performance" class="cell markdown"
id="SeQHPljbLfPl">
<h3>Model Tuning for Optimal Performance:</h3>
<p>Now, we'll fine-tune our selected model using the ParamGridBuilder
and CrossValidator. The model we've chosen for optimization is Random
Forest, as it strikes a favorable balance between F1 score, accuracy,
and computational efficiency. In our initial assessment, Random Forest
achieved an F1 score of 0.87, an accuracy of 0.88, and completed in 2
minutes and 57 seconds. In comparison, Gradient Boosted Trees (GBT)
achieved similar F1 and accuracy scores of 0.88 but took significantly
longer, at 3 minutes and 51 seconds.</p>
<h4 id="random-forest">Random Forest</h4>
<p>To determine the parameters we can fine-tune for the Random Forest
model, let's examine its available options:</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="PexPOWuZLfPl" data-outputId="4a04d4d7-eec7-46b0-c92c-4eb35df64a34">
<div class="sourceCode" id="cb246"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(random_forest_model.explainParams())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>bootstrap: Whether bootstrap samples are used when building trees. (default: True)
cacheNodeIds: If false, the algorithm will pass trees to executors to match instances with nodes. If true, the algorithm will cache node IDs for each instance. Caching can speed up training of deeper trees. Users can set how often should the cache be checkpointed or disable it by setting checkpointInterval. (default: False)
checkpointInterval: set checkpoint interval (&gt;= 1) or disable checkpoint (-1). E.g. 10 means that the cache will get checkpointed every 10 iterations. Note: this setting will be ignored if the checkpoint directory is not set in the SparkContext. (default: 10)
featureSubsetStrategy: The number of features to consider for splits at each tree node. Supported options: &#39;auto&#39; (choose automatically for task: If numTrees == 1, set to &#39;all&#39;. If numTrees &gt; 1 (forest), set to &#39;sqrt&#39; for classification and to &#39;onethird&#39; for regression), &#39;all&#39; (use all features), &#39;onethird&#39; (use 1/3 of the features), &#39;sqrt&#39; (use sqrt(number of features)), &#39;log2&#39; (use log2(number of features)), &#39;n&#39; (when n is in the range (0, 1.0], use n * number of features. When n is in the range (1, number of features), use n features). default = &#39;auto&#39; (default: auto)
featuresCol: features column name. (default: features, current: features)
impurity: Criterion used for information gain calculation (case-insensitive). Supported options: entropy, gini (default: gini)
labelCol: label column name. (default: label, current: label)
leafCol: Leaf indices column name. Predicted leaf index of each instance in each tree by preorder. (default: )
maxBins: Max number of bins for discretizing continuous features.  Must be &gt;=2 and &gt;= number of categories for any categorical feature. (default: 32)
maxDepth: Maximum depth of the tree. (&gt;= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes. Must be in range [0, 30]. (default: 5)
maxMemoryInMB: Maximum memory in MB allocated to histogram aggregation. If too small, then 1 node will be split per iteration, and its aggregates may exceed this size. (default: 256)
minInfoGain: Minimum information gain for a split to be considered at a tree node. (default: 0.0)
minInstancesPerNode: Minimum number of instances each child must have after split. If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be &gt;= 1. (default: 1)
minWeightFractionPerNode: Minimum fraction of the weighted sample count that each child must have after split. If a split causes the fraction of the total weight in the left or right child to be less than minWeightFractionPerNode, the split will be discarded as invalid. Should be in interval [0.0, 0.5). (default: 0.0)
numTrees: Number of trees to train (&gt;= 1). (default: 20)
predictionCol: prediction column name. (default: prediction)
probabilityCol: Column name for predicted class conditional probabilities. Note: Not all models output well-calibrated probability estimates! These probabilities should be treated as confidences, not precise probabilities. (default: probability)
rawPredictionCol: raw prediction (a.k.a. confidence) column name. (default: rawPrediction)
seed: random seed. (default: 7218912909096899330, current: 2023)
subsamplingRate: Fraction of the training data used for learning each decision tree, in range (0, 1]. (default: 1.0)
thresholds: Thresholds in multi-class classification to adjust the probability of predicting each class. Array must have length equal to the number of classes, with values &gt; 0, excepting that at most one value may be 0. The class with largest value p/t is predicted, where p is the original probability of that class and t is the class&#39;s threshold. (undefined)
weightCol: weight column name. If this is not set or empty, we treat all instance weights as 1.0. (undefined)
</code></pre>
</div>
</div>
<section id="parameters-for-model-tuning" class="cell markdown"
id="u70F5ZFqR60O">
<h3>Parameters for Model Tuning:</h3>
<p>For optimizing our Random Forest (RF) model, we'll focus on adjusting
the following key parameters:</p>
<ul>
<li><p>NumTrees: We will explore a range of values up to 100 for this
parameter. Increasing the number of trees in the ensemble can enhance
model performance. However, as each tree is a randomized model, there's
limited risk of overfitting with this parameter.</p></li>
<li><p>MaxDepth: We will consider a maximum depth of 15 for the decision
trees within the ensemble. Setting a reasonable maximum depth helps
mitigate the risk of overfitting. Going beyond a depth of 15 would
significantly increase the likelihood of overfitting.</p></li>
<li><p>NumFolds: Initially, we intended to use numFolds = 5 for
cross-validation, but we have adjusted it to 3 to expedite the tuning
process. This change should help speed up the parameter optimization
process.</p></li>
</ul>
</section>
<div class="cell code" id="EK2c6PyiSR6P">
<div class="sourceCode" id="cb248"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameter grid</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> ParamGridBuilder() <span class="op">\</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    .addGrid(random_forest_model.numTrees, [<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>]) <span class="op">\</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>    .addGrid(random_forest_model.maxDepth, [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>]) <span class="op">\</span></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure the CrossValidator</span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>cross_validator <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>random_forest_model,</span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>                                 estimatorParamMaps<span class="op">=</span>param_grid,</span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>                                 evaluator<span class="op">=</span>f1_evaluator,  <span class="co"># Using F1 score for evaluation</span></span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>                                 numFolds<span class="op">=</span><span class="dv">3</span>)  <span class="co"># Adjusted to 3 for faster processing</span></span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="-BXCAOCwSTbt" data-outputId="a12a295b-bb9b-45a3-e617-822b89900c42">
<div class="sourceCode" id="cb249"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>cvModel <span class="op">=</span> cross_validator.fit(train)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>CPU times: user 16.7 s, sys: 3.6 s, total: 20.3 s
Wall time: 36min 41s
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="UZrdUOOhTEdb" data-outputId="fb1979e7-a7d8-4b5a-e947-e41692ef9825">
<div class="sourceCode" id="cb251"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>cvModel.avgMetrics</span></code></pre></div>
<div class="output execute_result" data-execution_count="180">
<pre><code>[0.7687411794554652,
 0.779137529137529,
 0.779137529137529,
 0.8162213301102189,
 0.8094186090217836,
 0.8094186090217836,
 0.8162213301102189,
 0.8094186090217836,
 0.8094186090217836]</code></pre>
</div>
</div>
<section id="final-performance-evaluation-of-the-best-model"
class="cell markdown" id="TZXm1qOGTi89">
<h3>Final Performance Evaluation of the Best Model:</h3>
<p>Now, let's obtain the conclusive performance results for our
optimized Random Forest (RF) model.</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="9lw1Iny0Tona" data-outputId="989fb0bc-edb6-4f74-88a8-1aa646a4ef58">
<div class="sourceCode" id="cb253"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform the validation data using the best model</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> cvModel.transform(valid)</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate accuracy</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> results.<span class="bu">filter</span>(results.label <span class="op">==</span> results.prediction).count() <span class="op">/</span> (results.count())</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the best model</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> cvModel.bestModel</span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the best parameters</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Best Parameter (numTrees):&quot;</span>, best_model._java_obj.getNumTrees())</span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Best Parameter (MaxDepth):&quot;</span>, best_model._java_obj.getMaxDepth())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Best Parameter (numTrees): 50
Best Parameter (MaxDepth): 5
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="IYSekgKDgPCP" data-outputId="095df007-3166-4154-b276-af4b1b129621">
<div class="sourceCode" id="cb255"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;F1 for our best model is:&#39;</span>, f1_evaluator.evaluate(predictions, {f1_evaluator.metricName: <span class="st">&quot;f1&quot;</span>}))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>F1 for our best model is: 0.7111111111111111
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="wMyBwqM0gQ7o" data-outputId="ee522a86-020e-4fb5-ebf0-eed3c9853b69">
<div class="sourceCode" id="cb257"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Accuracy for our best model is:&#39;</span>, f1_evaluator.evaluate(predictions, {f1_evaluator.metricName: <span class="st">&quot;accuracy&quot;</span>}))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Accuracy for our best model is: 0.8
</code></pre>
</div>
</div>
<section id="feature-importance-analysis-for-the-best-model"
class="cell markdown" id="2Gh3SZ_Qg-AS">
<h3>Feature Importance Analysis for the Best Model:</h3>
<p>Now, we can examine the feature importance for our best model and
visualize it using a chart.</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:656}"
id="Hs9Qigk_g72r" data-outputId="fa498af7-19f0-4b57-9999-c034f17025ec">
<div class="sourceCode" id="cb259"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feature importances from the best model</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>importances <span class="op">=</span> best_model.featureImportances</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define feature names</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>feature_list <span class="op">=</span> [<span class="st">&quot;level&quot;</span>, <span class="st">&quot;avg_song&quot;</span>, <span class="st">&quot;roll_ad&quot;</span>, <span class="st">&quot;thumbs_down&quot;</span>, <span class="st">&quot;thumbs_up&quot;</span>, <span class="st">&quot;add_friend&quot;</span>, <span class="st">&quot;playlist&quot;</span>, <span class="st">&quot;num_artists&quot;</span>, <span class="st">&quot;days&quot;</span>]</span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create x-axis values for plotting</span></span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>x_values <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(importances)))</span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar chart</span></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>,<span class="dv">6</span>])</span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>plt.bar(x_values, importances, orientation<span class="op">=</span><span class="st">&#39;vertical&#39;</span>)</span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>plt.xticks(x_values, feature_list, rotation<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Importance&#39;</span>)</span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Feature&#39;</span>)</span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Feature Importances&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="187">
<pre><code>Text(0.5, 1.0, &#39;Feature Importances&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a7d830fca13144e2b0872217687dac90/fefeab8aa183fbf19184bd11088199d92db327ed.png" /></p>
</div>
</div>
<div class="cell markdown" id="GpheAF04iBml">
<p>In our analysis, we observe that the most influential feature are
"add_friend" and "days since registered," while "thumbs_down" appear to
be the least influential features.</p>
</div>
<div class="cell markdown" id="HMf1vetSitHP">
<h3 id="conclusions">Conclusions:</h3>
<p>Our project began with a relatively small dataset, comprising just
128MB and 225 unique customers. We embarked on a comprehensive data
processing journey, which involved data loading, cleaning, and feature
engineering. Through diligent exploration, we identified and crafted the
most promising features for predicting churn. Subsequently, we applied
various machine learning algorithms to these features, with the Random
Forest algorithm emerging as the top performer. After fine-tuning the
Random Forest model, we achieved an impressive accuracy and F1 score of
0.88.</p>
<h3 id="business-impact">Business Impact:</h3>
<p>The insights gained from this project hold substantial potential for
Sparkify. By identifying customers at risk of churning, Sparkify can
strategically target them with enticing incentives to retain their
business. This not only safeguards Sparkify's revenue but also ensures a
more satisfying experience for customers. The findings highlight the
significance of newer customers in the churn prediction process,
suggesting that Sparkify could offer complimentary trials of premium
services without advertisements to this segment. Additionally, refining
music recommendation systems to enhance user engagement and satisfaction
is a valuable future prospect.</p>
<h3 id="project-reflection">Project Reflection:</h3>
<p>This project provided valuable learning experiences in data
manipulation using Spark, feature engineering for churn prediction, and
the implementation of machine learning models within the Spark
environment. Transitioning from conventional pandas-based modeling to
Spark's capabilities was a noteworthy aspect of this project. The Random
Forest classifier emerged as the most effective model, achieving an
accuracy and F1 score of 0.8 .</p>
<h3 id="future-work">Future Work:</h3>
<p>To further enhance this project, we could explore the following
areas:</p>
<ul>
<li><p>In-depth Feature Engineering: Extensive feature engineering could
lead to the selection of even more impactful features, potentially
improving model performance.</p></li>
<li><p>Overfitting Mitigation: A more thorough investigation into
overfitting issues and implementing strategies to mitigate them could
enhance model robustness.</p></li>
<li><p>Misclassification Analysis: Delving into the cases of
misclassified users can offer insights into the specific characteristics
or patterns that lead to mispredictions.</p></li>
</ul>
<p>Overall, this project opens doors for continued refinement and
optimization in churn prediction for Sparkify.</p>
</div>
</body>
</html>
